
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kurobaraのブログ</title>
  <meta name="author" content="kurobara">

  
  <meta name="description" content="はじめに とあるログファイルを解析する必要があったわけなのですが
以下の状況のようなファイルでした 中途半端にDateTimeが出力されている
但し、unixtimpstampであれば確実に出力されている なので、正確に発生日時を調べる必要が出てきました 変換コマンド Linuxの場合であれば、 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://moonstruckdrops.github.com/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="kurobaraのブログ" type="application/atom+xml">
  <link href="/stylesheets/table.css" rel="stylesheet" type="text/css" />

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:moonstruckdrops.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">
        <span class="blue_light">
            kurobaraのブログ
        </span>
       
           <span class="blue_dark">
             〜ネタを書き散らすだけのようなブログ〜
           </span>
       
    </a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <!--
  <li><a href="/about">About me</a></li>
  -->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/04/unixtime-to-datetime/">unixtimestampをDatetimeに変更する</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-04T12:54:00+09:00" pubdate data-updated="true">Oct 4<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>とあるログファイルを解析する必要があったわけなのですが<br/>
以下の状況のようなファイルでした</p>

<ul>
<li>中途半端にDateTimeが出力されている</li>
<li>但し、unixtimpstampであれば確実に出力されている</li>
</ul>


<p>なので、正確に発生日時を調べる必要が出てきました</p>

<h3>変換コマンド</h3>

<hr />

<p>Linuxの場合であれば、以下を実行するだけなのでそんなに難しくない</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ date --date '@1443883848'
</span><span class='line'>2015年 10月  3日 土曜日 23:50:48 JST</span></code></pre></td></tr></table></div></figure>


<p>Macの場合であれば、Homebrewで<code>coreutils</code>をインストールしてあれば以下を実行するだけ
(以下のような形でフォーマットの設定が必要ですが・・・)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gdate --date '@1443883848' +'%Y/%m/%d %H:%M'
</span><span class='line'>2015/10/03 23:50</span></code></pre></td></tr></table></div></figure>


<p>ログ解析用のバッチにこのコマンドを仕掛ければ簡単に使えそうですね</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/10/devise-email/">Deviseでemailを空白でもよいようにする</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-10T10:22:00+09:00" pubdate data-updated="true">Aug 10<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>やりたいこと</h3>

<hr />

<p>以下の２つを実現したい</p>

<ul>
<li>ユーザー登録した場合はemailの入力は不要</li>
<li>ユーザー情報編集時、emailが空文字でも、uniqueバリデーションに引っかからないよう</li>
<li>ただし、uniqueは別なもので担保</li>
</ul>


<h3>対応方法</h3>

<hr />

<ol>
<li>indexの削除</li>
<li>別のものでuniqueを担保</li>
<li>email判定のロジック箇所をオーバライド</li>
</ol>


<h3>indexの削除</h3>

<hr />

<p>以下のコマンドでマイグレーション用ファイルを作成する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration remove_index_email_from_users</span></code></pre></td></tr></table></div></figure>


<p>以下のように実装し、migrationを実行する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RemoveIndexEmailFromUsers &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    remove_index :users, column: :email, unique: true
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>別のものでuniqueを担保</h3>

<hr />

<p>こちらは普通にunique制約と<code>validates_uniqueness_of</code>を付与するのみ</p>

<p>とりあえずunique制約のみ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration add_index_item_from_users</span></code></pre></td></tr></table></div></figure>


<p>以下のような形でunique制約をつける</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddIndexItemFromUsers &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    add_index :users, :item, unique: true
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>こんな感じにしておく</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  validates_uniqueness_of :item
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>email判定のロジック箇所をオーバライド</h3>

<hr />

<p>emailカラムには<a href="https://github.com/plataformatec/devise/blob/c179cef365f7188c91cbbc3db924a9f1f9563c3c/lib/devise/models/validatable.rb#L29">バリデーションが設定されている</a>ので、<br/>
これをオーバライドすることでバリデーション周りの挙動を変更できる</p>

<p><a href="https://github.com/plataformatec/devise/blob/c179cef365f7188c91cbbc3db924a9f1f9563c3c/lib/devise/models/validatable.rb#L58">判定箇所を追いかける</a>と、デフォルトで有効になっているのでここをfalseに変更する</p>

<p>こんな感じにしておく</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  def email_required?
</span><span class='line'>    false
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>勿論、状況によって<code>email_required?</code>が必要なこともあるのでここは要仕様検討というところでしょうか。</p>

<p>当たり前ですが、デカイライブラリなので、ちょっとしたことをやるだけでも結構ややこし目の実装だったりソースを読むことが必須になりますね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/27/rails-sti/">RailsでSTI（単一テーブル継承）の予約語でハマった話対処</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-27T11:38:00+09:00" pubdate data-updated="true">Jun 27<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>ここ数日、自分用のアプリを作っているわけなのですが<br/>
その時に起きたエラーを記載しておきます</p>

<p>(STIの予約語のこと忘れてたというオチｗ)</p>

<h3>事象</h3>

<hr />

<p>ActiveRecordで「type」というカラムをもつテーブルに接続し、取得系のメソッドを呼ぶと以下の様なエラーが出た</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1] pry(main)&gt; Hoge.find(1)
</span><span class='line'>  Hoge Load (0.4ms)  SELECT `hoges`.* FROM `hoges` WHERE `hoges`.`id` = 1 LIMIT 1
</span><span class='line'>ActiveRecord::SubclassNotFound: The single-table inheritance mechanism failed to locate the subclass: 'fuga'. This error is raised because the column 'type' is reserved for storing the class in case of inheritance. Please rename this column if you didn't intend it to be used for storing the inheritance class or overwrite Hoge.inheritance_column to use another column for that information.</span></code></pre></td></tr></table></div></figure>


<p>エラーメッセージから分かるように「type」というカラムをrenameしろと出ています<br/>
こんなの場合によっては出来無いわけで・・・</p>

<h3>これは何？</h3>

<hr />

<p>STI（単一テーブル継承）と呼ばれる機能のことを指しています<br/>
つまり、1つのテーブルを複数のModelで利用する仕組みのことを言います。</p>

<p>で、その仕掛けように予約語として、&#8221;type&#8221;という名前をActiveRecordが利用しているようです。</p>

<p>クラスで言うとこんなところでしょうか。<br/>
Humanクラスを継承した、Manクラス、Womanクラスがあったとした場合、以下のような形になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Human &lt; ActiveRecord::Base
</span><span class='line'>
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class Man &lt; Human
</span><span class='line'>
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class Woman &lt; Human
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>で、例えばManオブジェクトをsaveすると、Humanテーブルにtype:Manとして保存されます。<br/>
Womanならtype:Womanになるようです</p>

<p>それぞれのモデルからデータへの操作を行った場合、適合するTypeのデータのみを操作対象となります<br/>
ManもWomanも関係なく取得したい(両方をまとめて扱いたい)場合は、Humanモデルから操作すればOKです</p>

<p>当然ひとつのテーブルを使っていますので、片方にしか無い項目(カラム)もテーブルに含まなければならないです。<br/>
例えばManとHumanの持つ項目があまりにも違う場合、カラム数が爆発的に増えます。<br/>
(ここは注意するところですね)</p>

<h3>対処</h3>

<hr />

<p>もうざっくりというと、以下の2つの対応ができます</p>

<ol>
<li>カラム名に「type」という名前をつけず、別名に変更する</li>
<li>エラーメッセージにあるようにSTIのカラム名を変更する</li>
</ol>


<p>というわけなので、自分は1の対応を行いました。</p>

<p>では、2の場合はどうするかというと・・・
エラーメッセージにありますが、以下ように設定すればよいようです</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Hoge &lt; ActiveRecord::Base
</span><span class='line'>  self.inheritance_column = :_type_disabled
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>どういう場合に起きそう</h3>

<hr />

<p>ざっと思いつくのはこんなところかな</p>

<ul>
<li>既存のアプリケーション(PHPなりJavaなり)をRailsにのせかえるとき</li>
<li>設計上どうしても止むえずつけたいとき(これはビジネスドメインの場合が当てはまる)</li>
<li>(あんまりないと思うが)STIの機能を使ってリファクタリングするとき</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/21/rails-migration-command/">Railsのモデル周りのマイグレーション</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-21T14:15:00+09:00" pubdate data-updated="true">Jun 21<span>st</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>Railsでmigrationするときにいつもアレなんだっけなぁとなることが多いので、<br/>
備忘録程度にまとめておく</p>

<p>こんなものドキュメント見れば理解できるので、ざっくりレベルのサマリー程度にしておく</p>

<h3>基本</h3>

<hr />

<p>マイグレーションファイル作成コマンド</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails generate migration クラス名</span></code></pre></td></tr></table></div></figure>


<p>モデル作成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails generate model モデル名</span></code></pre></td></tr></table></div></figure>


<h3>モデル&amp;テーブル作成</h3>

<hr />

<p>フィールド指定で作成する場合、以下の形で行う<br/>
(大体はフィールド指定を行わずに、実行することが多いかも)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g model モデル名 フィールド:型</span></code></pre></td></tr></table></div></figure>


<h3>カラムの型指定</h3>

<hr />

<p>細かい調整をしようと思えばできるけど、一旦これだけ覚えておけば良い</p>

<table>
<thead>
<tr>
<th align="left">Ruby側の型 </th>
<th align="left"> DB側の型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> string </td>
<td align="left"> 文字列</td>
</tr>
<tr>
<td align="left"> text </td>
<td align="left"> 長い文字列</td>
</tr>
<tr>
<td align="left"> integer </td>
<td align="left"> 整数</td>
</tr>
<tr>
<td align="left"> float </td>
<td align="left"> 浮動小数</td>
</tr>
<tr>
<td align="left"> decimal </td>
<td align="left"> 精度の高い小数</td>
</tr>
<tr>
<td align="left"> datetime </td>
<td align="left"> 日時</td>
</tr>
<tr>
<td align="left"> timestamp </td>
<td align="left"> タイムスタンプ</td>
</tr>
<tr>
<td align="left"> time </td>
<td align="left"> 時間</td>
</tr>
<tr>
<td align="left"> date </td>
<td align="left"> 日付</td>
</tr>
<tr>
<td align="left"> binary </td>
<td align="left"> バイナリデータ</td>
</tr>
<tr>
<td align="left"> boolean </td>
<td align="left"> Boolean</td>
</tr>
</tbody>
</table>


<h3>(補足)MySQLで使用する場合の文字列型</h3>

<hr />

<p>MySQLで使用できる文字列型は以下が存在している</p>

<table>
<thead>
<tr>
<th align="left"> DB側の型 </th>
<th align="left"> 内容</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> CHAR </td>
<td align="left"> 255Bまでの固定長文字列</td>
</tr>
<tr>
<td align="left"> VARCHAR </td>
<td align="left"> 64KBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> TINYTEXT </td>
<td align="left"> 255Bまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> TEXT </td>
<td align="left"> 64KBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> MEDIUMTEXT </td>
<td align="left"> 約1.6MBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> LONGTEXT </td>
<td align="left"> 約4.3GBまでの可変長文字列</td>
</tr>
</tbody>
</table>


<p>上記をそれぞれmigrationで利用する場合<br/>
以下のようにlimitをつけることで、使用する文字列型を変更することができる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CreateHoges &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    create_table :articles do |t|
</span><span class='line'>      t.text :value, :limit =&gt; 4294967295
</span><span class='line'>
</span><span class='line'>      t.timestamps null: false
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>実行すると以下のようになる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails db
</span><span class='line'>mysql&gt; show columns from hoges;
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+
</span><span class='line'>| Field       | Type         | Null | Key | Default | Extra          |
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+
</span><span class='line'>| id          | int(11)      | NO   | PRI | NULL    | auto_increment |
</span><span class='line'>| value       | longtext     | YES  |     | NULL    |                |
</span><span class='line'>| created_at  | datetime     | NO   |     | NULL    |                |
</span><span class='line'>| updated_at  | datetime     | NO   |     | NULL    |                |
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+</span></code></pre></td></tr></table></div></figure>


<p>limitの値は、以下のように対応している</p>

<table>
<thead>
<tr>
<th align="left"> 設定値 </th>
<th align="left"> DB側の型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> 1 ~ 255 </td>
<td align="left"> TINYTEXT</td>
</tr>
<tr>
<td align="left"> 256 ~ 65535 </td>
<td align="left"> TEXT</td>
</tr>
<tr>
<td align="left"> 65536 ~ 16777215 </td>
<td align="left"> MEDIUMTEXT</td>
</tr>
<tr>
<td align="left"> 16777216 ~ 4294967295 </td>
<td align="left"> LONGTEXT</td>
</tr>
</tbody>
</table>


<h3>マイグレーション実行</h3>

<hr />

<p>DB作成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:create</span></code></pre></td></tr></table></div></figure>


<p>マイグレーションの実行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:migrate</span></code></pre></td></tr></table></div></figure>


<p>マイグレーション結果確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:migrate:status</span></code></pre></td></tr></table></div></figure>


<p>ロールバック</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:rollback</span></code></pre></td></tr></table></div></figure>


<p>DBの削除</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:drop</span></code></pre></td></tr></table></div></figure>


<p>シードの投入(マスターデータなどシードで投入することが多い)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:seed</span></code></pre></td></tr></table></div></figure>


<h3>既存カラムの変更</h3>

<hr />

<p>カラムを変更したい場合、以下のコマンドでマイグレーションファイルを生成する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration ChangeColumnTo&lt;モデル名&gt;</span></code></pre></td></tr></table></div></figure>


<p>変更は以下のような形で行う(upとdownを定義することでrollbackにも対応できる)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ChangeColumnToYourModel&lt; ActiveRecord::Migration
</span><span class='line'>
</span><span class='line'>  # 変更内容
</span><span class='line'>  def up
</span><span class='line'>    change_column :users, :hoge, :string, null: false, default: 0
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  # 変更前の状態
</span><span class='line'>  def down
</span><span class='line'>    change_column :users, :hoge, :string, null: true, default: 0
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>気をつけることとして、change_columnは以下のような順で記載すること</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>change_column :&lt;テーブル名&gt;, :&lt;カラム名&gt;, :&lt;型&gt;, &lt;default値やindexといったオプション指定&gt;</span></code></pre></td></tr></table></div></figure>


<h3>カラムの追加/削除</h3>

<hr />

<p>カラムの追加/削除をしたい場合、以下のコマンドでマイグレーションファイルを生成する<br/>
追加の場合は、フィールド指定可能</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration AddColumnTo&lt;モデル&gt;</span></code></pre></td></tr></table></div></figure>


<p>以下のような形で記載する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddColumnToYourModel &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>
</span><span class='line'>    # 追加
</span><span class='line'>    add_column :hoges, :hoge, :string
</span><span class='line'>
</span><span class='line'>    # 削除
</span><span class='line'>    remove_column :hoges, :fuga, :string
</span><span class='line'>
</span><span class='line'>    # 追加する場所を指定する場合
</span><span class='line'>    add_column :hoges, :fugafuga, :string, :after =&gt; :hoge
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>インデックスの追加/削除</h3>

<hr />

<p>カラムの追加/削除と基本は変わらない</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration AddIndexTo&lt;モデル&gt;</span></code></pre></td></tr></table></div></figure>


<p>以下のようにしてindexを設定する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddIndexToYourModel &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>
</span><span class='line'>    # 追加
</span><span class='line'>    add_index :hoges, :hoge
</span><span class='line'>
</span><span class='line'>    # 削除
</span><span class='line'>    remove_index :hoges, :fuga
</span><span class='line'>
</span><span class='line'>    # 複合インデックスの場合
</span><span class='line'>    add_index :hoges, [:hoge, :fuga]
</span><span class='line'>
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>参考</h3>

<hr />

<p>ここに書いてる内容は、Railsドキュメント見れば一発で理解できるけどな</p>

<ul>
<li><a href="http://railsdoc.com/model">モデル(model)</a></li>
<li><a href="http://railsdoc.com/migration">マイグレーション(migration)</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/06/mysqldump/">テーブル単位のmysqldump</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-06T23:39:00+09:00" pubdate data-updated="true">May 6<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>めちゃくちゃ基礎的な内容なのですが、備忘録を兼ねてメモしておく</h2>

<h3>DBまるごと</h3>

<p>よくやるmysqldumpコマンド</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$mysqldump -u root -p development_db  &gt; db_backup.sql</span></code></pre></td></tr></table></div></figure>


<h3>テーブル単位</h3>

<p>tオプションは、「テーブル作成情報（CREATE TABLE ステートメント）を書き込まない」という内容を指す<br/>
migrationなどで先にテーブルを作った場合とかに有効活用できる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$mysqldump -u root -p -t development_db my_table1 my_table2 &gt; table_backup.sql</span></code></pre></td></tr></table></div></figure>


<p>上のコマンドのようにテーブル名は複数指定可能(my_table1, my_table2などが該当)</p>

<h3>リストア</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$mysql -u root -p development_db &lt; summaries.sql</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/17/android-build-config/">BuildConfigを使用して、環境ごとに値を取得仕分けてみる</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-17T23:57:00+09:00" pubdate data-updated="true">Mar 17<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>WebAPIと連携するようなAndroidアプリを作っているのですが
開発と本番で接続先を切り替える必要が出てきました。</p>

<p>それのライトな対応方法をメモ</p>

<h3>build.gradleを編集</h3>

<hr />

<p>以下のような形で記載</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>buildTypes {
</span><span class='line'>  debug {
</span><span class='line'>    buildConfigField "String", "API_URL", "\"http://api-dev.hoge.co.jp\""
</span><span class='line'>  }
</span><span class='line'>  release {
</span><span class='line'>    buildConfigField "String", "API_URL", "\"http://api.hoge.co.jp\""
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>ソースコード側</h3>

<hr />

<p>以下のように特に気にせずBuildConfigを参照すればよい</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>String url = BuildConfig.API_URL</span></code></pre></td></tr></table></div></figure>


<p>ビルド環境に応じた値が取得できる</p>

<h3>できたけど・・・</h3>

<hr />

<p>これぐらいなら、まぁbuild.gradleでいいやという気がするもののパラメータ増えたら収拾つかなくなる予感</p>

<p>真面目にやるならBuild Variantsを使うほうがよいかと思います</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/17/jersey-on-heroku/">Heroku上でJersey + Jetty + Gradleを動かす</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-17T01:14:00+09:00" pubdate data-updated="true">Mar 17<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>JavaでRestfulといえば、JAX-RSが有名ですね。</p>

<p>それを扱いやすくしたFrameworkといえば、<a href="https://jersey.java.net/">Jersey</a>になります。<br/>
これをHerokuで動かすようにしてみます。</p>

<p>ついでにオワコン臭漂うmavenを辞めて、Gradleでビルドができるようにもしてみます</p>

<h3>目標</h3>

<hr />

<p>以下ができていること</p>

<ul>
<li>Heroku上でJerseyが動くこと</li>
<li>HerokuではJettyがサーブレット・コンテナとして動くこと</li>
<li>ビルドツールには、デフォルトのmavenではなくGradleであること</li>
</ul>


<h3>Jersey</h3>

<hr />

<p>まずはmaven ArchTypeから必要なファイルを準備</p>

<p><a href="https://jersey.java.net/download.html">ここ</a>を参考にすると、ArchTypeは2種類あることが分かります。</p>

<p>今回はJettyで動かすので、サーブレットコンテナ用のものを使います</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn archetype:generate -DarchetypeGroupId=org.glassfish.jersey.archetypes -DarchetypeArtifactId=jersey-quickstart-webapp -DarchetypeVersion=2.17</span></code></pre></td></tr></table></div></figure>


<p>必要項目を聞かれますので、以下のような感じで入力していきます</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Define value for property 'groupId': : kurobara
</span><span class='line'>Define value for property 'artifactId': : kurobara
</span><span class='line'>Define value for property 'version': 1.0-SNAPSHOT:
</span><span class='line'>Define value for property 'package': kurobara: kurobara</span></code></pre></td></tr></table></div></figure>


<p>成功すれば、以下の構成になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── pom.xml
</span><span class='line'>├── src
</span><span class='line'>│   └── main
</span><span class='line'>│       ├── java
</span><span class='line'>│       │   └── kurobara
</span><span class='line'>│       │       └── MyResource.java
</span><span class='line'>│       ├── resources
</span><span class='line'>│       └── webapp
</span><span class='line'>│           ├── WEB-INF
</span><span class='line'>│           │   └── web.xml
</span><span class='line'>│           └── index.jsp</span></code></pre></td></tr></table></div></figure>


<h3>mavenの削除</h3>

<hr />

<p>普通に考えると、mavenを使わなければpom.xmlを残してもよいかと思います(自分も最初は思いました)
Herokuではmavenがデフォルトで使われますので、削除してしまいます</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rm pom.xml</span></code></pre></td></tr></table></div></figure>


<p>どうやら、mavenとGradleの両方のビルドファイルが存在するとHerokuではmavenのものが最優先で使われるようです</p>

<h3>Gradleの追加</h3>

<hr />

<p>以下の内容を<code>build.gradle</code>に記載します</p>

<p>このファイルのミソは<code>task stage(dependsOn: ['clean', 'installApp'])</code>を記載していることです。
Herokuではこのタスクが必要なようです。</p>

<p><a href="https://github.com/heroku/devcenter-gradle">公式</a>を参考にしました。</p>

<p>多分、必要無いと思いますが念のためgradlewも用意しました(自分は一応、これもファイルに追加しています)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apply plugin: "java"
</span><span class='line'>apply plugin: "war"
</span><span class='line'>apply plugin: "jetty"
</span><span class='line'>apply plugin: 'application'
</span><span class='line'>
</span><span class='line'>group = "kurobara"
</span><span class='line'>version = 1.0
</span><span class='line'>sourceCompatibility = 1.7
</span><span class='line'>mainClassName = "kurobara"
</span><span class='line'>applicationName = "kurobara"
</span><span class='line'>
</span><span class='line'>def defaultEncoding = 'UTF-8'
</span><span class='line'>[
</span><span class='line'>  compileJava,
</span><span class='line'>  compileTestJava,
</span><span class='line'>  javadoc
</span><span class='line'>]*.options*.encoding = defaultEncoding
</span><span class='line'>
</span><span class='line'>repositories {
</span><span class='line'>  mavenLocal()
</span><span class='line'>  maven { url "http://maven.seasar.org/maven2" }
</span><span class='line'>  mavenCentral()
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>dependencies {
</span><span class='line'>  compile 'org.eclipse.jetty:jetty-server:9.2.10.v20150310'
</span><span class='line'>  compile 'org.eclipse.jetty:jetty-webapp:9.2.10.v20150310'
</span><span class='line'>  compile 'org.glassfish.jersey.core:jersey-server:2.17'
</span><span class='line'>  compile 'org.glassfish.jersey.containers:jersey-container-servlet-core:2.17'
</span><span class='line'>
</span><span class='line'>  testCompile 'junit:junit:4.10'
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>task stage(dependsOn: ['clean', 'installApp'])
</span><span class='line'>
</span><span class='line'>[jettyRun, jettyRunWar]*.httpPort = 8090
</span><span class='line'>[jettyRun, jettyRunWar]*.contextPath = 'kurobara'
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>task wrapper(type: Wrapper) {
</span><span class='line'>  gradleVersion = '1.6'
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Jettyの準備</h3>

<hr />

<p>最低限度の内容でJettyサーバが動くようにします</p>

<p>mainメソッドにサーバの実装を記載します。</p>

<p>Gradleに記載したように、これがmainClassになります(mainClassNameを参照)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import org.eclipse.jetty.server.Server;
</span><span class='line'>import org.eclipse.jetty.webapp.WebAppContext;
</span><span class='line'>
</span><span class='line'>public class Main {
</span><span class='line'>
</span><span class='line'>  public static void main(String[] args) throws Exception {
</span><span class='line'>      Server server = new Server(Integer.valueOf(System.getenv("PORT")));
</span><span class='line'>
</span><span class='line'>      WebAppContext context = new WebAppContext();
</span><span class='line'>      context.setServer(server);
</span><span class='line'>      context.setContextPath("/");
</span><span class='line'>      context.setResourceBase("src/main/webapp");
</span><span class='line'>      context.setClassLoader(Main.class.getClassLoader());
</span><span class='line'>      server.setHandler(context);
</span><span class='line'>
</span><span class='line'>      server.start();
</span><span class='line'>      server.join();
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>以下の構成になるようにMainクラスを配置します</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── build.gradle
</span><span class='line'>├── src
</span><span class='line'>│   └── main
</span><span class='line'>│       ├── java
</span><span class='line'>│       │   └── kurobara
</span><span class='line'>│       │       ├── Main.java &lt;- これを追加
</span><span class='line'>│       │       └── MyResource.java
</span><span class='line'>│       ├── resources
</span><span class='line'>│       └── webapp
</span><span class='line'>│           ├── WEB-INF
</span><span class='line'>│           │   └── web.xml
</span><span class='line'>│           └── index.jsp</span></code></pre></td></tr></table></div></figure>


<h3>動作確認</h3>

<hr />

<p>まずは、テストが動くかどうか確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$gradle clean
</span><span class='line'>$gradle test</span></code></pre></td></tr></table></div></figure>


<p>次にアプリをビルドし、サーバを起動</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$gradle clean
</span><span class='line'>$gradle build
</span><span class='line'>$gradle jettyRunWar</span></code></pre></td></tr></table></div></figure>


<p>以下のコマンドで<code>Got it!</code>が返却されるか確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -v http://localhost:8090/kurobara/webapi/myresource</span></code></pre></td></tr></table></div></figure>


<h3>Heroku環境用の準備</h3>

<hr />

<p>Herokuで動かすJavaのバージョンを指定するsystem.propertiesを作成<br/>
(以下のようにとりあえず確実に動作するバージョンを指定)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java.runtime.version=1.7</span></code></pre></td></tr></table></div></figure>


<p>Procfileに記載するスクリプトファイルの確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$gradle stage</span></code></pre></td></tr></table></div></figure>


<p>こういう形にビルド結果が出力されているので、アプリケーション起動スクリプトのファイルパスを確認する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── build
</span><span class='line'>│   ├── classes
</span><span class='line'>│   │   └── main
</span><span class='line'>│   │       └── kurobara
</span><span class='line'>│   │           ├── Main.class
</span><span class='line'>│   │           └── MyResource.class
</span><span class='line'>│   ├── dependency-cache
</span><span class='line'>│   ├── install
</span><span class='line'>│   │   └── kurobara
</span><span class='line'>│   │       ├── bin
</span><span class='line'>│   │       │   ├── kurobara &lt;- これが起動用ファイル
</span><span class='line'>│   │       │   └── kurobara.bat</span></code></pre></td></tr></table></div></figure>


<p>生成したスクリプトファイルパスをProcfileに記載</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>web: ./build/install/kurobara/bin/kurobara</span></code></pre></td></tr></table></div></figure>


<p>不要ファイルを無視するように.gitignoreを作成<br/>
(Herokuへのデプロイはgitのため)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>build/
</span><span class='line'>.gradle/</span></code></pre></td></tr></table></div></figure>


<p>最終的に以下の構成になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── .gitignore
</span><span class='line'>├── Procfile
</span><span class='line'>├── build.gradle
</span><span class='line'>├── src
</span><span class='line'>│   └── main
</span><span class='line'>│       ├── java
</span><span class='line'>│       │   └── moonstruckdrops
</span><span class='line'>│       │       ├── Main.java
</span><span class='line'>│       │       └── MyResource.java
</span><span class='line'>│       ├── resources
</span><span class='line'>│       └── webapp
</span><span class='line'>│           ├── WEB-INF
</span><span class='line'>│           │   └── web.xml
</span><span class='line'>│           └── index.jsp
</span><span class='line'>└── system.properties</span></code></pre></td></tr></table></div></figure>


<h3>Herokuへdeploy</h3>

<hr />

<p>herokuへloginする</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew install heroku
</span><span class='line'>$ heroku login</span></code></pre></td></tr></table></div></figure>


<p>サーバへデプロイする</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git init
</span><span class='line'>$ git add .
</span><span class='line'>$ git commit -m "Ready to deploy"
</span><span class='line'>$ git remote add heroku your_heroku_path
</span><span class='line'>$ git push heroku master</span></code></pre></td></tr></table></div></figure>


<p>以下のコマンドで<code>Got it!</code>が返却されるか動作確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$curl -v http://your_app.herokuapp.com/webapi/myresource</span></code></pre></td></tr></table></div></figure>


<h3>感想</h3>

<hr />

<p>書くと簡単でしたが、実際にやってみると思った以上に嵌まりどころが多かった</p>

<p>特に以下が盛大な罠でした</p>

<ul>
<li>Procfileに書くファイルはどれなのか</li>
<li><code>heroku logs</code>を確認すると<code>app crash</code>と表示されて何がなんだかわからんかったこと</li>
<li><code>app crash</code>起因ですがweb.xmlはいじらなくてもいいのか？なんて思ったこと</li>
</ul>


<p>一度環境さえ準備できれば開発に専念できるようになるので、非常に楽ですね</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/17/apache-plus-tomcat/">なぜApacheとTomcatを連携させるのか</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-17T00:12:00+09:00" pubdate data-updated="true">Mar 17<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>同僚とApacheとTomcatって何で連携させるんだっけ？<br/>
という話が出たので備忘録的に記載しておきます</p>

<p>ぶっちゃけ、今更感がすごい内容ですが・・・</p>

<h3>Apache</h3>

<hr />

<p>ざっくり言うと、クライアントのブラウザからアクセスし、サービスを提供するためのWebサーバソフトウェア</p>

<h3>Tomcat</h3>

<hr />

<p>こちらもざっくり言うと、以下のもの</p>

<ul>
<li>「サーブレット・コンテナ」(Servlet等を動作させるために必要なWebアプリケーションサーバ)</li>
<li>Servletのインスタンス管理やセッションの管理</li>
<li>Webサーバ機能有り(主に開発とデバッグ用)</li>
</ul>


<h3>連携理由</h3>

<hr />

<p>開発、デバッグ用途としてWebサーバ機能があるので、問題はないのですが
そもそもとして、ApacheなどのWebサーバの性能と同等に捌けるかは疑問があったりするところ</p>

<p>なので、以下の処理分担としたほうが効率よく捌けるため連携をさせることが多い</p>

<ul>
<li>静的コンテンツ(HTMLや画像ファイルなど)の処理はApacheが担当(何故なら、高速でTomcatに比べて高速に処理できるから)</li>
<li>動的コンテンツに関しての処理をTomcatが担当</li>
</ul>


<p>所謂、餅は餅屋ということですな</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/18/api-life-cycle/">APIを作る際のAPIバージョンに関するメモ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-18T23:19:00+09:00" pubdate data-updated="true">Feb 18<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>APIを作るときにどうするか？を開発チーム内で議論したので、備忘録的なメモ</p>

<p>発端となった会話は、こんな感じだったはず</p>

<p>「マイクロアーキテクチャなサービスを作ったときってAPIを作ると思うけど、ライフサイクルって考えてる？」<br/>
「APIを利用するフロントは更新できるけど、APIは依存されるものが多いから簡単には更新できないよね？」<br/>
「APIってモバイルアプリからも利用した場合、修正しづらくない？バージョン管理でもするの？」</p>

<h3>APIの種別</h3>

<hr />

<p>以下の３つぐらいになりそう</p>

<ul>
<li>外部公開向け</li>
<li>モバイルアプリ向け</li>
<li>webサービス向け</li>
</ul>


<h3>外部公開向け</h3>

<hr />

<ul>
<li>API変更の影響が大きい</li>
<li>ドキュメント更新必須</li>
<li>利用者が離れるのでドラスティックな変更はできない</li>
<li>利用者への周知が必須</li>
</ul>


<h3>モバイルアプリ向け</h3>

<hr />

<ul>
<li>アプリのみが影響を受けるので、API変更における影響は少ない</li>
<li>アプリバージョンによるので自由にAPI更新ができない</li>
<li>OSバージョンによってアプリのアップデートができないことが多いので、更新によって使えなくなる可能性有</li>
<li>更新API対応のアプリであっても、アプリが更新されることは無いと思ったほうがよい</li>
</ul>


<h3>webサービス向け</h3>

<hr />

<ul>
<li>クライアントもAPIに合わせて最新にできるので、変更しやすい</li>
<li>キャッシュされたクライアントのコードとのデータ不整合が起きやすい</li>
<li>キャッシュに振り回される(iOSのwebview等)</li>
</ul>


<h3>バージョニング方式</h3>

<hr />

<p>APIのバージョン管理方式は以下のものが採用される傾向にある</p>

<ol>
<li>アクセス先URIそのものを大きく変更する</li>
<li>URIにバージョンを埋め込む</li>
<li>クエリに使用APIバージョンを入れる</li>
<li>メディアタイプにバージョンを指定する</li>
</ol>


<p>世間的には、2のパターンが比較的多く採用される傾向</p>

<h3>URIにバージョンを埋め込み方式</h3>

<hr />

<ul>
<li>「v1」のように「v」をつけてバージョンを明確にすることが多い</li>
<li>日付やリリースバージョン(ハッシュ等)をバージョンにするAPIもある(twillo等)</li>
<li>URIに組み込むバージョンは、メジャー番号のみを含める</li>
<li>APIの修正は、後方互換を保ちつつ対応する</li>
</ul>


<p>バージョニングは以下のセマンティックバージョニング方式を取ることが多い</p>

<ul>
<li>パッチバージョンは、ソフトウェアのAPIに変更がないバグ修正を行ったときに増える</li>
<li>マイナーバージョンは後方互換がある機能変更、特定の機能追加のときに増える</li>
<li>メジャーバージョンは後方互換が無い変更の時に増える</li>
</ul>


<h3>メディアタイプにバージョンを指定する</h3>

<hr />

<ul>
<li>「Accept: application/vnd.example.v2+json」のような形で規定する</li>
<li>URIがリソースを表しているので、HTTPの文法に則っている</li>
<li>「Content-Type」の指定誤りで、サーバ、クライアント側ともにエラーになりやすい傾向</li>
</ul>


<h3>バージョン変更指針</h3>

<hr />

<ul>
<li>APIは基本変更しないほうがよい</li>
<li>変更は後方互換を保ちつつ対応できる場合は、マイナーバージョンアップ(可能な限りこちらを選択)</li>
<li>後方互換が保てない修正の場合はメジャーバージョンアップ</li>
<li>レスポンスデータ整合性/整理のためであれば、バージョンは上げない(後方互換を維持し続け、ドキュメント整理で対応)</li>
</ul>


<h3>メジャーバージョンアップ指針</h3>

<hr />

<p>後方互換が保てない場合のみ実施し、バージョンアップのルールを整理してから行う</p>

<ul>
<li>セキュリティ/権限などのAPI使用ルール変更</li>
<li>認証方式の変更</li>
<li>乱雑に作った(ルールが無い)APIを使いやすくするための整備</li>
</ul>


<h3>APIの提供終了</h3>

<hr />

<ul>
<li>API提供終了前に提供終了日時のアナウンスをする(提供終了後、半年ほどは動かしておくこと)</li>
<li>提供終了までにAPIを利用できなくするブラックアウトテストを数回実施する</li>
<li>API提供終了の仕様をドキュメントに盛り込んでおく(HTTPのステータスコード410(Gone)を返すなど)</li>
<li>利用期限をAPI提供開始時に決めておく</li>
<li>古いAPIを叩いたときに、新APIへのリダイレクトは、混乱を招くので避けたほうがよい</li>
</ul>


<p># モバイル向けAPIの場合、ユーザー体験に直結するので仕様として予め考えておく(モバイル向けの場合、APIの停止はトレンドを見つつ行うこと)
# アプリのアップデートを促すようにしておく(強制アップデートは好まれないが、使えなくなるよりも遥かにマシ)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/18/linux-login-check/">Linuxのログイン履歴確認</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-18T01:20:00+09:00" pubdate data-updated="true">Feb 18<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>毎度なんだっけ？ってなって思い出すのが面倒なので、備忘録的にログイン履歴確認方法を記録</p>

<h3>最近ログインしたアカウント一覧</h3>

<hr />

<p>以下のコマンドで確認できる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$last</span></code></pre></td></tr></table></div></figure>


<p>実行結果(上に行くほど最新)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root     tty1                          Tue May  6 18:59 - crash  (00:16)
</span><span class='line'>root     tty1                          Tue May  6 18:58 - 18:59  (00:00)
</span><span class='line'>reboot   system boot  2.6.32-431.11.2. Tue May  6 17:16 - 21:21  (04:04)</span></code></pre></td></tr></table></div></figure>


<h3>ログファイルから確認する</h3>

<hr />

<p>もう少し細かく見る場合はログファイルを確認する<br/>
バイナリなので中を見たいときはwhoコマンドを使用する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$who /var/log/wtmp</span></code></pre></td></tr></table></div></figure>


<p>実行結果(ログファイルなので、ファイル末尾が新しい)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root     tty1         2014-05-06 18:58
</span><span class='line'>root     tty1         2014-05-06 18:59
</span><span class='line'>root     tty1         2014-05-06 19:19</span></code></pre></td></tr></table></div></figure>


<h3>各アカウントの最終ログインの一覧</h3>

<hr />

<p>普段利用していないアカウントでログインされていないか確認できる<br/>
以下のコマンドで確認できる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$lastlog</span></code></pre></td></tr></table></div></figure>


<p>実行結果(各アカウントの最終ログインが表示)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ユーザ名         ポート   場所             最近のログイン
</span><span class='line'>root             tty1                      **一度もログインしていません**
</span><span class='line'>bin                                        **一度もログインしていません**
</span><span class='line'>daemon                                     **一度もログインしていません**
</span><span class='line'>adm                                        **一度もログインしていません**
</span><span class='line'>lp                                         **一度もログインしていません**
</span><span class='line'>sync                                       **一度もログインしていません**
</span><span class='line'>shutdown                                   **一度もログインしていません**</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>どうやらSEをやっているらしい。</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/02/07/sudo-and-x-and-ssh/">sshでX11 Forwardingをsudoコマンド時に実施する方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/30/walkman-playlist-converter/">GroovyでWALKMAN用のプレイリストコンバーターを作成した</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/20/android-groovy/">AndroidでGroovyを使ってみる</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/13/ruby-kaigi/">RubyKaigi3日目に行ってきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/12/ruby-kaigi/">RubyKaigi2日目に行ってきた</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tag Cloud</h1>
  <span id="tag-cloud"><a href='/blog/categories/android' style='font-size: 127.0%'>Android(9)</a> <a href='/blog/categories/api' style='font-size: 106.0%'>API(2)</a> <a href='/blog/categories/devlove' style='font-size: 103.0%'>DevLove(1)</a> <a href='/blog/categories/devops' style='font-size: 103.0%'>DevOps(1)</a> <a href='/blog/categories/emacs' style='font-size: 115.0%'>Emacs(5)</a> <a href='/blog/categories/gas' style='font-size: 103.0%'>GAS(1)</a> <a href='/blog/categories/git' style='font-size: 112.0%'>git(4)</a> <a href='/blog/categories/go' style='font-size: 103.0%'>Go(1)</a> <a href='/blog/categories/googlemap' style='font-size: 103.0%'>GoogleMap(1)</a> <a href='/blog/categories/groovy' style='font-size: 103.0%'>Groovy(1)</a> <a href='/blog/categories/hackathon' style='font-size: 103.0%'>Hackathon(1)</a> <a href='/blog/categories/ide' style='font-size: 103.0%'>IDE(1)</a> <a href='/blog/categories/ios' style='font-size: 103.0%'>iOS(1)</a> <a href='/blog/categories/java' style='font-size: 121.0%'>Java(7)</a> <a href='/blog/categories/javascript' style='font-size: 103.0%'>JavaScript(1)</a> <a href='/blog/categories/linux' style='font-size: 133.0%'>Linux(11)</a> <a href='/blog/categories/mac' style='font-size: 118.0%'>Mac(6)</a> <a href='/blog/categories/markdown' style='font-size: 118.0%'>markdown(6)</a> <a href='/blog/categories/mysql' style='font-size: 103.0%'>MySQL(1)</a> <a href='/blog/categories/python' style='font-size: 103.0%'>Python(1)</a> <a href='/blog/categories/ruby' style='font-size: 160.0%'>Ruby(20)</a> <a href='/blog/categories/shellscript' style='font-size: 103.0%'>ShellScript(1)</a> <a href='/blog/categories/solr' style='font-size: 103.0%'>Solr(1)</a> <a href='/blog/categories/戯言' style='font-size: 124.0%'>戯言(8)</a> </span>
</section






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - kurobara -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
