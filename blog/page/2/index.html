
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kurobaraのブログ</title>
  <meta name="author" content="kurobara">

  
  <meta name="description" content="はじめに RubyKaigi2日目に参加してきました。 気になるセッションもチラホラあり期待していました ただ、盛大に寝坊しましたorz という訳で、メモ Data Analytics Service Company and Its Ruby Usage ミドルウェア
* &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://moonstruckdrops.github.com/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="kurobaraのブログ" type="application/atom+xml">
  <link href="/stylesheets/table.css" rel="stylesheet" type="text/css" />

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:moonstruckdrops.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">
        <span class="blue_light">
            kurobaraのブログ
        </span>
       
           <span class="blue_dark">
             〜ネタを書き散らすだけのようなブログ〜
           </span>
       
    </a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <!--
  <li><a href="/about">About me</a></li>
  -->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/12/ruby-kaigi/">RubyKaigi2日目に行ってきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-12T13:24:00+09:00" pubdate data-updated="true">Dec 12<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>RubyKaigi2日目に参加してきました。</p>

<p>気になるセッションもチラホラあり期待していました</p>

<p>ただ、盛大に寝坊しましたorz</p>

<p>という訳で、メモ</p>

<h3>Data Analytics Service Company and Its Ruby Usage</h3>

<hr />

<p>ミドルウェア
* データ処理をする上でスループットが重要
* 一度書いたものはそのまま運用されるので、固めにつくることが多い</p>

<p>集めてくるところとか、加工整形した結果などは固くつくる必要はない
(書捨ても多いから)</p>

<p>要素</p>

<ul>
<li>データを集めて保存</li>
<li>総うさするコンソr−るapi</li>
<li>データしゅべつ、型だとかのスキーマ管理</li>
<li>計算処理(batch,query)-> Java</li>
<li>キューイングやスケジュール処理</li>
<li>データを格納&amp;エクスポート</li>
</ul>


<p>キューとワーカーの話</p>

<p>perfedtsched(スケジューラー)
→SPOFのないcrontabと思えばよい
→1回も実行されないよりも２回実行されたほうがよい(別途担保が必要だが・・・)</p>

<p>リトライ可能かは、状況やエラー内容による
実行時間
jobの実行内容が重いものやら軽いものまで</p>

<p>perfectqueue(キュー)</p>

<ul>
<li>優先どの高いキューは高いものは素早く処理</li>
<li>graceful restart(字工事のjobは分離して実行)</li>
<li>RDBMSのようなinsertで実現</li>
<li>RDS(MySQL)を使ってる</li>
</ul>


<p>パフォーマンスコントロールとかでジョブ実行を制御している
安全側に倒している(顧客情報のisolationとか)</p>

<p>何故Rubyを使っているか</p>

<ul>
<li>ワーカーのコードが複雑だけど重要</li>
<li>テストが一番重要なので、書きやすいのでrspecを採用</li>
<li>テストコードの書きやすさが重要だった(可読性とか、オーバーライドとか)</li>
<li>新しい機能とか新しいライブラリは使っていく</li>
</ul>


<p>スケジューラーとキュー気になる</p>

<h3>Ruby for one day game programming camp for beginners</h3>

<hr />

<p>京大マイコンクラブで事例</p>

<p>Windowsの環境が殆どなので以下を実行するようにした</p>

<ul>
<li>Ruby1.8.4(starter kit)</li>
<li>MyGame and Ruby/SDL(ゲーム用)</li>
<li>sakura editor</li>
</ul>


<p>インストールして終わりぐらいの単純なものがよい</p>

<ul>
<li>講義みたいなことはしない</li>
<li>1対1のペアプロ</li>
<li>楽しいRubyが教本</li>
</ul>


<p>プログラム未経験の参加者の8割が大体できる
→やる気に繋がる
→自信によって自分が勉強する</p>

<p>考察してみる</p>

<ul>
<li>教えかたが勉強できる</li>
<li>つくるものが決まっている</li>
<li>締め切り</li>
<li>教えるものが少ない(基本的な制御構造)</li>
</ul>


<h3>Ruby and PostgreSQL, a love story</h3>

<hr />

<p>plmruby
zombodb</p>

<ul>
<li>producael language handler(他の言語のサポート)</li>
<li>indexがすぐれてる(通常indexだけなく、elastic searchとかのラッパーにもできる)</li>
<li>foreginData(他にデータが投げられる, csvなりなんなりにｄけいる)</li>
</ul>


<p>postgresql fdl</p>

<ul>
<li>callbackルーチンで駆動するライフサイクル(コールバックチェーンかな)</li>
<li>rubyがサポートする</li>
</ul>


<p>holycorn</p>

<h3>Rhebok, High Performance Rack Handler</h3>

<hr />

<p>Rhebok</p>

<ul>
<li>rack handler</li>
<li>unicorn比較で1.5x</li>
<li>gazelle(perlnのpluck)の置き換え</li>
</ul>


<p>使いドコロ</p>

<ul>
<li>高いトラフィックのあるところ</li>
<li>最適化が進んでるところに最適(SNS, gameとか)</li>
<li>rackがネックになったとき</li>
</ul>


<p>使えないところ</p>

<ul>
<li>websocket</li>
<li>streaming</li>
<li>リバースプロキシかまさないといけない</li>
</ul>


<p>性能</p>

<ul>
<li>http1.1(keepaliveは未サポート)</li>
<li>unix socket</li>
<li>ホットデプロイ可能</li>
<li>rackアプリの起動でOK</li>
</ul>


<p>Rack</p>

<ul>
<li>仕様(webserverとF/WをつなぐI/F)</li>
<li>middleware</li>
<li>Rack::Handlerの名前空間の下に同時実装をすれば自動認識できる</li>
</ul>


<p>パフォーマンス上げる</p>

<ul>
<li>マルチプロセス</li>
<li>マルチスレッド</li>
<li>IO多重化</li>
</ul>


<p>timeoutの実現</p>

<ul>
<li>IO.selectを使用する</li>
<li>pollを使うことで実現</li>
</ul>


<p>parser</p>

<ul>
<li>pico_http_parserに渡すように変更</li>
</ul>


<p>tcp</p>

<ul>
<li>tco_nodelayをオフにする</li>
<li>バッファリング遅延対策</li>
<li>tcpのやり取りが増えるのでフラグメンテーションいっぱい</li>
<li>書き込み回数を1回にしておく</li>
</ul>


<h3>Pragmatic Testing of Ruby Core</h3>

<p>テストを実行してみる
テストが落ちた報告をするといい</p>

<p>Makefleにテストがなく、common.mkにある
btest-ruby => bootstraptest
sample/test.rbが通った後に実行(runner.rb経由で実行)
make test-allなどは、標準ライブラリのテスト</p>

<p>make test-all TESTS=&#8221;-j4&#8221;すると並列で動く</p>

<p>test/ruby : 組み込み
test/logger : 添付ライブラリ
test/-ext- : C拡張</p>

<p>envutil.rb &lt;- ヤバイ
leakchecker.rb</p>

<p>rubyspecは現行の振る舞いだけしか書いてないので、
言語仕様ではない(by Matz)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/12/ar-default-timezone/">ActiveRecord単体で使用した際に単一モデルにdefault_timezoneを設定する</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-12T12:50:00+09:00" pubdate data-updated="true">Dec 12<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>DBアクセスがあるような検証用のプログラムを書いたりするときってActiveRecord便利ですよね</p>

<p>このとき、timezoneの設定がうまくいって無くてすごく嵌ったので備忘録代わりにメモしておきます</p>

<h3>設定方法</h3>

<hr />

<p>単純にこれだけです</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class TestModel &lt; ActiveRecord::Base
</span><span class='line'>  self.default_timezone = :local
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>もしくはこちらでもよいかと</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class TestModel &lt; ActiveRecord::Base
</span><span class='line'>  def self.default_timezone
</span><span class='line'>    :local
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>簡単でしたね</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/11/2015-ruby-kaigi/">RubyKaigi１日目に行ってきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-11T10:09:00+09:00" pubdate data-updated="true">Dec 11<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>ここ最近はRubyを書くことが少なくなってきたのですが、<br/>
RubyKaigiの一日目に行ってきた</p>

<p>ミドルウェアとかインフラとか、設計とかコードから離れた生活を繰り広げております</p>

<p>RubyKaigiの一日目は、これまた時間と仕事の都合上午前中のみしか参加できずorz</p>

<p>なので、一日目は、keynoteだけ聞いてきました</p>

<p>Crystalにも興味はあったので、ちょっと気になるのですがここは涙を飲んで・・・</p>

<p>ところでマネーフォワードさん、すごいですね。</p>

<p>Rubyコミッターのフルタイム採用とか松田さんの技術顧問就任とか。</p>

<p>という訳でメモを残しておく</p>

<h3>keynote</h3>

<hr />

<p>プログラマーの美徳</p>

<ul>
<li>怠惰(怠けるための努力をしない)</li>
<li>ガマンしない(PCが活用されていないことに怒る)</li>
<li>傲慢(ソフトウェアのクォリティ)</li>
</ul>


<p>全て、怒りに通じている<br/>
(Rubyにケチ付けられていることも・・・)</p>

<p>怒りは伝染るので、親切も伝染る</p>

<p>なので、内心腹たってても親切に対応するといいことがある</p>

<p>親切な対応が多いので、Rubyコミュニティは素晴らしい</p>

<h4>最近のニュース</h4>

<ul>
<li>Ruby2.3.0リリースが出た(クリスマスにリリースする)</li>
<li>RubyKaigiに合わせてやった</li>
<li>もしかして機能をつけた(NameErrorの際にスペル指摘とか)</li>
<li>Enumerable#grep_vが追加(マッチしないものを提示)</li>
<li>Hash#fetch_at(指定しないキーがあれば例外)</li>
<li>Numeric#negative? positive?</li>
<li>Hashの包含関係をチェックできるようになった</li>
<li>Hash#to_proc(h= {1: 2,2: 4,4: 6} (1..3)..map(&amp;h))</li>
<li>Array,Hash#digメソッド追加(data.dig(:user, 0)のようにあればアクセスして値を返す)</li>
<li>ヒアドキュメントにチルダをつけると、インデントの浅いところに合わせる</li>
<li>frozen-string-literalをつけると、文字列に追加するとエラー、パフォーマンスがよくなる&amp;エラーがはっきりする</li>
<li>safe navigation オペレーター「&amp;.」の追加(ぼっちオペレーター・・・) u &amp;&amp; u.first &amp;&amp; u.name が u&amp;.first&amp;.name になる</li>
<li>年に5%~10%の改善(2.3も同様)</li>
</ul>


<p>よくなる提案を受け入れてもっと良い物をという、Rubyコミュニティの成果</p>

<ul>
<li>mruby1.2</li>
<li><p>ビルドプロセスとか、諸々の改善</p></li>
<li><p>Streem</p></li>
<li>githubに公開してた</li>
<li>何もしないのに取り上げられて、色々とバズってしまった</li>
</ul>


<h4>Ruby3</h4>

<ul>
<li>変化はコスト、苦痛</li>
<li>言語デザインは難しい</li>
<li>矛盾する要求がある</li>
</ul>


<p>未来の状況はわからない</p>

<p>スクリプト言語にオブジェクト指向要らない<br/>
→21世紀になってくると何らかの形でオブジェクト指向を持つものが多くなった<br/>
→人に合わせてつくることが無かった<br/>
新しい当たり前になれた<br/>
Ruby成功の秘訣<br/>
webappの分野ではトップ近くまでなれた<br/>
とはいえ、言語して完成しているわけではない</p>

<p>互換性の問題や、移行の問題(5年かかった)<br/>
# Python3よりはマシ</p>

<p>全部を捨てることはせず、段階的に変化させていく方法を取った<br/>
１つずつ、テストを書いて確認して実施<br/>
移行パスの提示</p>

<p>ドラスティックな変更はしないし、ひとつずつの進歩<br/>
バージョニング問題(1.8 vs 1.9のときは除くの轍は踏まなかった)は他の言語のようなことは起きなかった</p>

<p>変化のうえで学んだこと</p>

<ul>
<li>何もかもいっぺんに捨てない</li>
<li>劇的な変化はしない(互換性を理由なく捨ててはいけない)</li>
<li>変化を続ける</li>
<li>ユーザーへの利益(簡潔にかけるとか)</li>
</ul>


<p>Ruby3では以下をやりたい</p>

<ul>
<li>マルチコアへの対応(開発当時はシングルコアでマルチスレッド)</li>
<li>コードの拡大(主戦場が変った)</li>
<li>扱うデータ量の増加でのパフォーマンス対応</li>
</ul>


<p>こんな感じ(約束はしていない)</p>

<ul>
<li>アクターモデル(goroutin+channelも一応こちらに)</li>
<li>オーナーシップモデル</li>
<li>STM(software transaction)は難しいし、無理かも</li>
<li>streamモデル</li>
<li>pipeラインを使ったイベントループ(２番めのVMを動かすことで実現)</li>
<li>コンパイルを賢く</li>
<li>soft typing(flowtyped interfaceでFlow / Crystal言語、ある程度の型チェックDialyzar(Erlang))</li>
<li>3倍早くをパフォーマンスも目標にする(Ruby2.0よりも３倍)</li>
<li>2020までにRuby3を出したい・・・</li>
<li>難しいことに挑戦</li>
<li>メモリを大量に使うけど、消費量をおさえるようにはしたい</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/06/edge-rails5/">Rails5を使ってみる</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-06T00:16:00+09:00" pubdate data-updated="true">Nov 6<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>とある要件があり、使用するFramework最近ブログネタに賑わっているRailsでということになった<br/>
せっかくなので、開発開始&amp;リリースはいつになるのかという噂のRails5を使ってみることにした</p>

<p>開発変更時期にRails5もリリースされているだろうという多少の先を見越す形でもありますがｗ</p>

<h3>準備</h3>

<hr />

<p>どうやら、後方互換とはなんだったのかの勢いで最新っぽいので、以下を準備します。</p>

<ul>
<li>Ruby2.2.2以降のインストール</li>
<li>railsのリポジトリをclone</li>
</ul>


<p>なにはともあれ、現時点の最新版だとスッキリした気分ですねw</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$git clone https://github.com/rails/rails.git</span></code></pre></td></tr></table></div></figure>


<h3>まずはバージョン情報</h3>

<hr />

<p>昔は<code>railties/bin/rails</code>だったのですが、<code>railties/exe/rails</code>変更になったようです<br/>
ちょっと焦りましたw</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./rails/railties/exe/rails -v
</span><span class='line'>/usr/local/var/rbenv/versions/2.2.2/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require': cannot load such file -- concurrent/map (LoadError)
</span><span class='line'>  from /usr/local/var/rbenv/versions/2.2.2/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require'
</span><span class='line'>  from /Users/moonstruckdrops/rails/activesupport/lib/active_support/inflector/inflections.rb:1:in `&lt;top (required)&gt;'
</span><span class='line'>  from /usr/local/var/rbenv/versions/2.2.2/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require'
</span><span class='line'>  from /usr/local/var/rbenv/versions/2.2.2/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require'
</span><span class='line'>  from /Users/moonstruckdrops/rails/activesupport/lib/active_support/inflections.rb:1:in `&lt;top (required)&gt;'
</span><span class='line'>    (省略)</span></code></pre></td></tr></table></div></figure>


<p>どうやら、<code>activesupport/activesupport.gemspec</code>を見ると、<br/>
<code>concurrent-ruby</code>が足りなかったようなので追加します(正式版では無く、alpha版が必要です)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$gem install concurrent-ruby -v 1.0.0.pre5 --no-ri --no-rdoc</span></code></pre></td></tr></table></div></figure>


<p>気を取り直してもう一度実行すると動作します</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./rails/railties/exe/rails -v
</span><span class='line'>Rails 5.0.0.alpha</span></code></pre></td></tr></table></div></figure>


<h3>プロジェクト生成</h3>

<hr />

<p>せっかくなのでRails-APIオプションを使います<br/>
(api以外のオプションはお好みで設定してください)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./rails/railties/exe/rails new my_app --api -d mysql -T --skip-javascript --skip-test-unit --skip-turbolinks</span></code></pre></td></tr></table></div></figure>


<p>が、そのまま実行してもエラーになりますのでGemfileを修正します</p>

<ul>
<li><code>rails</code>は、cloneしたソースコードになるようにする</li>
<li><code>rack</code>,<code>arel</code>はgit or cloneしたソースコードになるようにする</li>
</ul>


<p>最終的にGemfileを以下のようにする(コメントのみ削除)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source 'https://rubygems.org'
</span><span class='line'>
</span><span class='line'>gem 'rack', path: '../rack'
</span><span class='line'>gem 'arel', path: '../arel'
</span><span class='line'>
</span><span class='line'>gem 'rails', '5.0.0.alpha', path: '../rails'
</span><span class='line'>gem 'mysql2', '&gt;= 0.3.18', '&lt; 0.5'
</span><span class='line'># gem 'bcrypt', '~&gt; 3.1.7'
</span><span class='line'>
</span><span class='line'># gem 'unicorn'
</span><span class='line'>
</span><span class='line'># gem 'capistrano-rails', group: :development
</span><span class='line'>
</span><span class='line'>gem 'active_model_serializers', '~&gt; 0.10.0.rc2'
</span><span class='line'>
</span><span class='line'># gem 'rack-cors'
</span><span class='line'>
</span><span class='line'>group :development, :test do
</span><span class='line'>  gem 'byebug'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>group :development do
</span><span class='line'>  gem 'spring'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>gem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw, :jruby]</span></code></pre></td></tr></table></div></figure>


<h3>起動する</h3>

<hr />

<p>ここは普段どおりにrackで起動します
rails</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cd my_app
</span><span class='line'>$bin/rails s
</span><span class='line'>=&gt; Booting WEBrick
</span><span class='line'>=&gt; Rails 5.0.0.alpha application starting in development on http://localhost:3000
</span><span class='line'>=&gt; Run `rails server -h` for more startup options
</span><span class='line'>=&gt; Ctrl-C to shutdown server
</span><span class='line'>[2015-11-06 00:00:05] INFO  WEBrick 1.3.1
</span><span class='line'>[2015-11-06 00:00:05] INFO  ruby 2.2.2 (2015-04-13) [x86_64-darwin14]
</span><span class='line'>[2015-11-06 00:00:05] INFO  WEBrick::HTTPServer#start: pid=14583 port=3000</span></code></pre></td></tr></table></div></figure>


<h3>ポイント</h3>

<hr />

<p>特に挙げることもないですが、
rails配下にあるgemspecファイルに目を通しておけば、インストールや起動に必須なgemがわかるので問題解決が早くなるということぐらいでしょうか</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/24/unicode-escape/">Pythonで文字変換</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-24T13:23:00+09:00" pubdate data-updated="true">Oct 24<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>AWSのLamdaを使ったのですが、どうも日本語が文字化けする形の模様<br/>
これをライトに解決したい<br/>
数が多いと使えないですが、少量の文字であれば直接Unicode Escapeする形にする</p>

<h3>やり方</h3>

<hr />

<p>Pythonの対話側インターフェースでライトに行う</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$python
</span><span class='line'>Python 2.7.10 (default, Jul 14 2015, 19:46:27)
</span><span class='line'>[GCC 4.2.1 Compatible Apple LLVM 6.0 (clang-600.0.39)] on darwin
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; s =  u'2015年春'
</span><span class='line'>&gt;&gt;&gt; s.encode('unicode_escape')
</span><span class='line'>'2015\\u5e74\\u6625'
</span><span class='line'>&gt;&gt;&gt; unicode('2015年春', 'UTF-8')
</span><span class='line'>u'2015\u5e74\u6625'
</span><span class='line'>&gt;&gt;&gt; exit
</span><span class='line'>Use exit() or Ctrl-D (i.e. EOF) to exit</span></code></pre></td></tr></table></div></figure>


<p>こんな感じ、別にAWS絡みではなくてもライトに使える</p>

<p>逆にデコードする場合、<code>s.decode('unicode-escape')</code>でできる</p>

<p>簡単ですね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/16/reverse-geocoding/">GoogleMapで逆Geocodingをしたい</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-16T11:08:00+09:00" pubdate data-updated="true">Oct 16<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>緯度と経度はわかるものの、住所がわからなくて困りまったことがありました。<br/>
特にGoogleMapのI/Fからは住所が導き出せなったので、ほとほと困り果てました。<br/>
ふと、その時ドキュメントを覗いたときに逆Geocodingができる記述があったのでやってみました。</p>

<h3>リクエストパラメータ</h3>

<hr />

<p>以下の表のように設定する</p>

<table>
<thead>
<tr>
<th align="left">パラメータ </th>
<th align="left"> 説明 </th>
<th align="left"> 指定方法 </th>
<th align="left"> 必須</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">address</td>
<td align="left">取得対象の住所</td>
<td align="left">テキスト</td>
<td align="left">latlngかどちらかを指定</td>
</tr>
<tr>
<td align="left">latlng</td>
<td align="left">取得対象の緯度軽度</td>
<td align="left">テキスト</td>
<td align="left">addressかどちらかを指定</td>
</tr>
<tr>
<td align="left">sensor</td>
<td align="left">位置センサーからのリクエストか</td>
<td align="left">boolean</td>
<td align="left">必ず指定する</td>
</tr>
<tr>
<td align="left">bounds</td>
<td align="left">ビューポートの境界ボックス(境界ボックスの南西と北東の角の緯度・経度で指定)</td>
<td align="left">テキスト</td>
<td align="left">  </td>
</tr>
<tr>
<td align="left">region</td>
<td align="left">地域コード(ccTLDの２文字)</td>
<td align="left">テキスト</td>
<td align="left">  </td>
</tr>
<tr>
<td align="left">language</td>
<td align="left">結果取得時の言語</td>
<td align="left">言語コード</td>
<td align="left">  </td>
</tr>
</tbody>
</table>


<p>boundsは以下のような形で指定する(緯度、経度がそれぞれどっちに向いてるのかを指定すると思えばよい)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>36.798805,-120.498805|136.733332,-130.498805</span></code></pre></td></tr></table></div></figure>


<h3>実行する</h3>

<p>以下のようにすることでjsonが返却される</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://maps.google.com/maps/api/geocode/json?latlng=36.798805,%20136.733332&sensor=false |jq .</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/04/unixtime-to-datetime/">unixtimestampをDatetimeに変更する</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-04T12:54:00+09:00" pubdate data-updated="true">Oct 4<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>とあるログファイルを解析する必要があったわけなのですが<br/>
以下の状況のようなファイルでした</p>

<ul>
<li>中途半端にDateTimeが出力されている</li>
<li>但し、unixtimpstampであれば確実に出力されている</li>
</ul>


<p>なので、正確に発生日時を調べる必要が出てきました</p>

<h3>変換コマンド</h3>

<hr />

<p>Linuxの場合であれば、以下を実行するだけなのでそんなに難しくない</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ date --date '@1443883848'
</span><span class='line'>2015年 10月  3日 土曜日 23:50:48 JST</span></code></pre></td></tr></table></div></figure>


<p>Macの場合であれば、Homebrewで<code>coreutils</code>をインストールしてあれば以下を実行するだけ
(以下のような形でフォーマットの設定が必要ですが・・・)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gdate --date '@1443883848' +'%Y/%m/%d %H:%M'
</span><span class='line'>2015/10/03 23:50</span></code></pre></td></tr></table></div></figure>


<p>ログ解析用のバッチにこのコマンドを仕掛ければ簡単に使えそうですね</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/10/devise-email/">Deviseでemailを空白でもよいようにする</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-10T10:22:00+09:00" pubdate data-updated="true">Aug 10<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>やりたいこと</h3>

<hr />

<p>以下の２つを実現したい</p>

<ul>
<li>ユーザー登録した場合はemailの入力は不要</li>
<li>ユーザー情報編集時、emailが空文字でも、uniqueバリデーションに引っかからないよう</li>
<li>ただし、uniqueは別なもので担保</li>
</ul>


<h3>対応方法</h3>

<hr />

<ol>
<li>indexの削除</li>
<li>別のものでuniqueを担保</li>
<li>email判定のロジック箇所をオーバライド</li>
</ol>


<h3>indexの削除</h3>

<hr />

<p>以下のコマンドでマイグレーション用ファイルを作成する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration remove_index_email_from_users</span></code></pre></td></tr></table></div></figure>


<p>以下のように実装し、migrationを実行する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RemoveIndexEmailFromUsers &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    remove_index :users, column: :email, unique: true
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>別のものでuniqueを担保</h3>

<hr />

<p>こちらは普通にunique制約と<code>validates_uniqueness_of</code>を付与するのみ</p>

<p>とりあえずunique制約のみ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration add_index_item_from_users</span></code></pre></td></tr></table></div></figure>


<p>以下のような形でunique制約をつける</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddIndexItemFromUsers &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    add_index :users, :item, unique: true
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>こんな感じにしておく</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  validates_uniqueness_of :item
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>email判定のロジック箇所をオーバライド</h3>

<hr />

<p>emailカラムには<a href="https://github.com/plataformatec/devise/blob/c179cef365f7188c91cbbc3db924a9f1f9563c3c/lib/devise/models/validatable.rb#L29">バリデーションが設定されている</a>ので、<br/>
これをオーバライドすることでバリデーション周りの挙動を変更できる</p>

<p><a href="https://github.com/plataformatec/devise/blob/c179cef365f7188c91cbbc3db924a9f1f9563c3c/lib/devise/models/validatable.rb#L58">判定箇所を追いかける</a>と、デフォルトで有効になっているのでここをfalseに変更する</p>

<p>こんな感じにしておく</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  def email_required?
</span><span class='line'>    false
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>勿論、状況によって<code>email_required?</code>が必要なこともあるのでここは要仕様検討というところでしょうか。</p>

<p>当たり前ですが、デカイライブラリなので、ちょっとしたことをやるだけでも結構ややこし目の実装だったりソースを読むことが必須になりますね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/27/rails-sti/">RailsでSTI（単一テーブル継承）の予約語でハマった話対処</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-27T11:38:00+09:00" pubdate data-updated="true">Jun 27<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>ここ数日、自分用のアプリを作っているわけなのですが<br/>
その時に起きたエラーを記載しておきます</p>

<p>(STIの予約語のこと忘れてたというオチｗ)</p>

<h3>事象</h3>

<hr />

<p>ActiveRecordで「type」というカラムをもつテーブルに接続し、取得系のメソッドを呼ぶと以下の様なエラーが出た</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1] pry(main)&gt; Hoge.find(1)
</span><span class='line'>  Hoge Load (0.4ms)  SELECT `hoges`.* FROM `hoges` WHERE `hoges`.`id` = 1 LIMIT 1
</span><span class='line'>ActiveRecord::SubclassNotFound: The single-table inheritance mechanism failed to locate the subclass: 'fuga'. This error is raised because the column 'type' is reserved for storing the class in case of inheritance. Please rename this column if you didn't intend it to be used for storing the inheritance class or overwrite Hoge.inheritance_column to use another column for that information.</span></code></pre></td></tr></table></div></figure>


<p>エラーメッセージから分かるように「type」というカラムをrenameしろと出ています<br/>
こんなの場合によっては出来無いわけで・・・</p>

<h3>これは何？</h3>

<hr />

<p>STI（単一テーブル継承）と呼ばれる機能のことを指しています<br/>
つまり、1つのテーブルを複数のModelで利用する仕組みのことを言います。</p>

<p>で、その仕掛けように予約語として、&#8221;type&#8221;という名前をActiveRecordが利用しているようです。</p>

<p>クラスで言うとこんなところでしょうか。<br/>
Humanクラスを継承した、Manクラス、Womanクラスがあったとした場合、以下のような形になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Human &lt; ActiveRecord::Base
</span><span class='line'>
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class Man &lt; Human
</span><span class='line'>
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class Woman &lt; Human
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>で、例えばManオブジェクトをsaveすると、Humanテーブルにtype:Manとして保存されます。<br/>
Womanならtype:Womanになるようです</p>

<p>それぞれのモデルからデータへの操作を行った場合、適合するTypeのデータのみを操作対象となります<br/>
ManもWomanも関係なく取得したい(両方をまとめて扱いたい)場合は、Humanモデルから操作すればOKです</p>

<p>当然ひとつのテーブルを使っていますので、片方にしか無い項目(カラム)もテーブルに含まなければならないです。<br/>
例えばManとHumanの持つ項目があまりにも違う場合、カラム数が爆発的に増えます。<br/>
(ここは注意するところですね)</p>

<h3>対処</h3>

<hr />

<p>もうざっくりというと、以下の2つの対応ができます</p>

<ol>
<li>カラム名に「type」という名前をつけず、別名に変更する</li>
<li>エラーメッセージにあるようにSTIのカラム名を変更する</li>
</ol>


<p>というわけなので、自分は1の対応を行いました。</p>

<p>では、2の場合はどうするかというと・・・
エラーメッセージにありますが、以下ように設定すればよいようです</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Hoge &lt; ActiveRecord::Base
</span><span class='line'>  self.inheritance_column = :_type_disabled
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>どういう場合に起きそう</h3>

<hr />

<p>ざっと思いつくのはこんなところかな</p>

<ul>
<li>既存のアプリケーション(PHPなりJavaなり)をRailsにのせかえるとき</li>
<li>設計上どうしても止むえずつけたいとき(これはビジネスドメインの場合が当てはまる)</li>
<li>(あんまりないと思うが)STIの機能を使ってリファクタリングするとき</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/21/rails-migration-command/">Railsのモデル周りのマイグレーション</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-21T14:15:00+09:00" pubdate data-updated="true">Jun 21<span>st</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>はじめに</h3>

<hr />

<p>Railsでmigrationするときにいつもアレなんだっけなぁとなることが多いので、<br/>
備忘録程度にまとめておく</p>

<p>こんなものドキュメント見れば理解できるので、ざっくりレベルのサマリー程度にしておく</p>

<h3>基本</h3>

<hr />

<p>マイグレーションファイル作成コマンド</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails generate migration クラス名</span></code></pre></td></tr></table></div></figure>


<p>モデル作成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails generate model モデル名</span></code></pre></td></tr></table></div></figure>


<h3>モデル&amp;テーブル作成</h3>

<hr />

<p>フィールド指定で作成する場合、以下の形で行う<br/>
(大体はフィールド指定を行わずに、実行することが多いかも)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g model モデル名 フィールド:型</span></code></pre></td></tr></table></div></figure>


<h3>カラムの型指定</h3>

<hr />

<p>細かい調整をしようと思えばできるけど、一旦これだけ覚えておけば良い</p>

<table>
<thead>
<tr>
<th align="left">Ruby側の型 </th>
<th align="left"> DB側の型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> string </td>
<td align="left"> 文字列</td>
</tr>
<tr>
<td align="left"> text </td>
<td align="left"> 長い文字列</td>
</tr>
<tr>
<td align="left"> integer </td>
<td align="left"> 整数</td>
</tr>
<tr>
<td align="left"> float </td>
<td align="left"> 浮動小数</td>
</tr>
<tr>
<td align="left"> decimal </td>
<td align="left"> 精度の高い小数</td>
</tr>
<tr>
<td align="left"> datetime </td>
<td align="left"> 日時</td>
</tr>
<tr>
<td align="left"> timestamp </td>
<td align="left"> タイムスタンプ</td>
</tr>
<tr>
<td align="left"> time </td>
<td align="left"> 時間</td>
</tr>
<tr>
<td align="left"> date </td>
<td align="left"> 日付</td>
</tr>
<tr>
<td align="left"> binary </td>
<td align="left"> バイナリデータ</td>
</tr>
<tr>
<td align="left"> boolean </td>
<td align="left"> Boolean</td>
</tr>
</tbody>
</table>


<h3>(補足)MySQLで使用する場合の文字列型</h3>

<hr />

<p>MySQLで使用できる文字列型は以下が存在している</p>

<table>
<thead>
<tr>
<th align="left"> DB側の型 </th>
<th align="left"> 内容</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> CHAR </td>
<td align="left"> 255Bまでの固定長文字列</td>
</tr>
<tr>
<td align="left"> VARCHAR </td>
<td align="left"> 64KBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> TINYTEXT </td>
<td align="left"> 255Bまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> TEXT </td>
<td align="left"> 64KBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> MEDIUMTEXT </td>
<td align="left"> 約1.6MBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> LONGTEXT </td>
<td align="left"> 約4.3GBまでの可変長文字列</td>
</tr>
</tbody>
</table>


<p>上記をそれぞれmigrationで利用する場合<br/>
以下のようにlimitをつけることで、使用する文字列型を変更することができる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CreateHoges &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    create_table :articles do |t|
</span><span class='line'>      t.text :value, :limit =&gt; 4294967295
</span><span class='line'>
</span><span class='line'>      t.timestamps null: false
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>実行すると以下のようになる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails db
</span><span class='line'>mysql&gt; show columns from hoges;
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+
</span><span class='line'>| Field       | Type         | Null | Key | Default | Extra          |
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+
</span><span class='line'>| id          | int(11)      | NO   | PRI | NULL    | auto_increment |
</span><span class='line'>| value       | longtext     | YES  |     | NULL    |                |
</span><span class='line'>| created_at  | datetime     | NO   |     | NULL    |                |
</span><span class='line'>| updated_at  | datetime     | NO   |     | NULL    |                |
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+</span></code></pre></td></tr></table></div></figure>


<p>limitの値は、以下のように対応している</p>

<table>
<thead>
<tr>
<th align="left"> 設定値 </th>
<th align="left"> DB側の型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> 1 ~ 255 </td>
<td align="left"> TINYTEXT</td>
</tr>
<tr>
<td align="left"> 256 ~ 65535 </td>
<td align="left"> TEXT</td>
</tr>
<tr>
<td align="left"> 65536 ~ 16777215 </td>
<td align="left"> MEDIUMTEXT</td>
</tr>
<tr>
<td align="left"> 16777216 ~ 4294967295 </td>
<td align="left"> LONGTEXT</td>
</tr>
</tbody>
</table>


<h3>マイグレーション実行</h3>

<hr />

<p>DB作成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:create</span></code></pre></td></tr></table></div></figure>


<p>マイグレーションの実行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:migrate</span></code></pre></td></tr></table></div></figure>


<p>マイグレーション結果確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:migrate:status</span></code></pre></td></tr></table></div></figure>


<p>ロールバック</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:rollback</span></code></pre></td></tr></table></div></figure>


<p>DBの削除</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:drop</span></code></pre></td></tr></table></div></figure>


<p>シードの投入(マスターデータなどシードで投入することが多い)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:seed</span></code></pre></td></tr></table></div></figure>


<h3>既存カラムの変更</h3>

<hr />

<p>カラムを変更したい場合、以下のコマンドでマイグレーションファイルを生成する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration ChangeColumnTo&lt;モデル名&gt;</span></code></pre></td></tr></table></div></figure>


<p>変更は以下のような形で行う(upとdownを定義することでrollbackにも対応できる)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ChangeColumnToYourModel&lt; ActiveRecord::Migration
</span><span class='line'>
</span><span class='line'>  # 変更内容
</span><span class='line'>  def up
</span><span class='line'>    change_column :users, :hoge, :string, null: false, default: 0
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  # 変更前の状態
</span><span class='line'>  def down
</span><span class='line'>    change_column :users, :hoge, :string, null: true, default: 0
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>気をつけることとして、change_columnは以下のような順で記載すること</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>change_column :&lt;テーブル名&gt;, :&lt;カラム名&gt;, :&lt;型&gt;, &lt;default値やindexといったオプション指定&gt;</span></code></pre></td></tr></table></div></figure>


<h3>カラムの追加/削除</h3>

<hr />

<p>カラムの追加/削除をしたい場合、以下のコマンドでマイグレーションファイルを生成する<br/>
追加の場合は、フィールド指定可能</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration AddColumnTo&lt;モデル&gt;</span></code></pre></td></tr></table></div></figure>


<p>以下のような形で記載する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddColumnToYourModel &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>
</span><span class='line'>    # 追加
</span><span class='line'>    add_column :hoges, :hoge, :string
</span><span class='line'>
</span><span class='line'>    # 削除
</span><span class='line'>    remove_column :hoges, :fuga, :string
</span><span class='line'>
</span><span class='line'>    # 追加する場所を指定する場合
</span><span class='line'>    add_column :hoges, :fugafuga, :string, :after =&gt; :hoge
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>インデックスの追加/削除</h3>

<hr />

<p>カラムの追加/削除と基本は変わらない</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration AddIndexTo&lt;モデル&gt;</span></code></pre></td></tr></table></div></figure>


<p>以下のようにしてindexを設定する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddIndexToYourModel &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>
</span><span class='line'>    # 追加
</span><span class='line'>    add_index :hoges, :hoge
</span><span class='line'>
</span><span class='line'>    # 削除
</span><span class='line'>    remove_index :hoges, :fuga
</span><span class='line'>
</span><span class='line'>    # 複合インデックスの場合
</span><span class='line'>    add_index :hoges, [:hoge, :fuga]
</span><span class='line'>
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>参考</h3>

<hr />

<p>ここに書いてる内容は、Railsドキュメント見れば一発で理解できるけどな</p>

<ul>
<li><a href="http://railsdoc.com/model">モデル(model)</a></li>
<li><a href="http://railsdoc.com/migration">マイグレーション(migration)</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>どうやらSEをやっているらしい。</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/05/26/shibuya-aab/">shibuya.apk主催のGoogleI/O 2018報告会にいってきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/21/ruby-kaigi/">RuubyKaigi2017に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/19/auth-gem/">認証系のgemをちょっと見てみた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/16/use-git-branch-command/">gitのブランチ系コマンドでよく使うもの</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/02/kotlin-study-for-kansai/">Kotlin 1.0リリース記念勉強会 in 京都に行ってきた</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tag Cloud</h1>
  <span id="tag-cloud"><a href='/blog/categories/android' style='font-size: 126.08695652173913%'>Android(10)</a> <a href='/blog/categories/api' style='font-size: 105.21739130434783%'>API(2)</a> <a href='/blog/categories/devlove' style='font-size: 102.6086956521739%'>DevLove(1)</a> <a href='/blog/categories/devops' style='font-size: 102.6086956521739%'>DevOps(1)</a> <a href='/blog/categories/emacs' style='font-size: 113.04347826086956%'>Emacs(5)</a> <a href='/blog/categories/gas' style='font-size: 102.6086956521739%'>GAS(1)</a> <a href='/blog/categories/git' style='font-size: 110.43478260869566%'>git(4)</a> <a href='/blog/categories/git' style='font-size: 102.6086956521739%'>Git(1)</a> <a href='/blog/categories/go' style='font-size: 102.6086956521739%'>Go(1)</a> <a href='/blog/categories/googlemap' style='font-size: 102.6086956521739%'>GoogleMap(1)</a> <a href='/blog/categories/groovy' style='font-size: 102.6086956521739%'>Groovy(1)</a> <a href='/blog/categories/hackathon' style='font-size: 102.6086956521739%'>Hackathon(1)</a> <a href='/blog/categories/ide' style='font-size: 102.6086956521739%'>IDE(1)</a> <a href='/blog/categories/ios' style='font-size: 102.6086956521739%'>iOS(1)</a> <a href='/blog/categories/java' style='font-size: 118.26086956521739%'>Java(7)</a> <a href='/blog/categories/javascript' style='font-size: 102.6086956521739%'>JavaScript(1)</a> <a href='/blog/categories/kotlin' style='font-size: 102.6086956521739%'>Kotlin(1)</a> <a href='/blog/categories/linux' style='font-size: 128.69565217391303%'>Linux(11)</a> <a href='/blog/categories/mac' style='font-size: 115.65217391304348%'>Mac(6)</a> <a href='/blog/categories/markdown' style='font-size: 115.65217391304348%'>markdown(6)</a> <a href='/blog/categories/mysql' style='font-size: 102.6086956521739%'>MySQL(1)</a> <a href='/blog/categories/python' style='font-size: 102.6086956521739%'>Python(1)</a> <a href='/blog/categories/ruby' style='font-size: 160.0%'>Ruby(23)</a> <a href='/blog/categories/shellscript' style='font-size: 102.6086956521739%'>ShellScript(1)</a> <a href='/blog/categories/solr' style='font-size: 102.6086956521739%'>Solr(1)</a> <a href='/blog/categories/戯言' style='font-size: 120.86956521739131%'>戯言(8)</a> </span>
</section






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - kurobara -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
