<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Ruby | kurobaraのブログ]]></title>
  <link href="http://moonstruckdrops.github.com/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://moonstruckdrops.github.com/"/>
  <updated>2015-10-16T11:26:28+09:00</updated>
  <id>http://moonstruckdrops.github.com/</id>
  <author>
    <name><![CDATA[kurobara]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[deviseでemailを空白でもよいようにする]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/08/10/devise-email/"/>
    <updated>2015-08-10T10:22:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/08/10/devise-email</id>
    <content type="html"><![CDATA[<h3>やりたいこと</h3>

<hr />

<p>以下の２つを実現したい</p>

<ul>
<li>ユーザー登録した場合はemailの入力は不要</li>
<li>ユーザー情報編集時、emailが空文字でも、uniqueバリデーションに引っかからないよう</li>
<li>ただし、uniqueは別なもので担保</li>
</ul>


<h3>対応方法</h3>

<hr />

<ol>
<li>indexの削除</li>
<li>別のものでuniqueを担保</li>
<li>email判定のロジック箇所をオーバライド</li>
</ol>


<h3>indexの削除</h3>

<hr />

<p>以下のコマンドでマイグレーション用ファイルを作成する</p>

<p><code>
$rails g migration remove_index_email_from_users
</code></p>

<p>以下のように実装し、migrationを実行する</p>

<p>```
class RemoveIndexEmailFromUsers &lt; ActiveRecord::Migration
  def change</p>

<pre><code>remove_index :users, column: :email, unique: true
</code></pre>

<p>  end
end
```</p>

<h3>別のものでuniqueを担保</h3>

<hr />

<p>こちらは普通にunique制約と<code>validates_uniqueness_of</code>を付与するのみ</p>

<p>とりあえずunique制約のみ</p>

<p><code>
$rails g migration add_index_item_from_users
</code></p>

<p>以下のような形でunique制約をつける</p>

<p>```
class AddIndexItemFromUsers &lt; ActiveRecord::Migration
  def change</p>

<pre><code>add_index :users, :item, unique: true
</code></pre>

<p>  end
end
```</p>

<p>こんな感じにしておく</p>

<p><code>
class User &lt; ActiveRecord::Base
  validates_uniqueness_of :item
end
</code></p>

<h3>email判定のロジック箇所をオーバライド</h3>

<hr />

<p>emailカラムには<a href="https://github.com/plataformatec/devise/blob/c179cef365f7188c91cbbc3db924a9f1f9563c3c/lib/devise/models/validatable.rb#L29">バリデーションが設定されている</a>ので、<br/>
これをオーバライドすることでバリデーション周りの挙動を変更できる</p>

<p><a href="https://github.com/plataformatec/devise/blob/c179cef365f7188c91cbbc3db924a9f1f9563c3c/lib/devise/models/validatable.rb#L58">判定箇所を追いかける</a>と、デフォルトで有効になっているのでここをfalseに変更する</p>

<p>こんな感じにしておく</p>

<p>```
class User &lt; ActiveRecord::Base
  def email_required?</p>

<pre><code>false
</code></pre>

<p>  end
end
```</p>

<p>勿論、状況によって<code>email_required?</code>が必要なこともあるのでここは要仕様検討というところでしょうか。</p>

<p>当たり前ですが、デカイライブラリなので、ちょっとしたことをやるだけでも結構ややこし目の実装だったりソースを読むことが必須になりますね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RailsでSTI（単一テーブル継承）の予約語でハマった話対処]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/06/27/rails-sti/"/>
    <updated>2015-06-27T11:38:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/06/27/rails-sti</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>ここ数日、自分用のアプリを作っているわけなのですが<br/>
その時に起きたエラーを記載しておきます</p>

<p>(STIの予約語のこと忘れてたというオチｗ)</p>

<h3>事象</h3>

<hr />

<p>ActiveRecordで「type」というカラムをもつテーブルに接続し、取得系のメソッドを呼ぶと以下の様なエラーが出た</p>

<p><code>
[1] pry(main)&gt; Hoge.find(1)
  Hoge Load (0.4ms)  SELECT `hoges`.* FROM `hoges` WHERE `hoges`.`id` = 1 LIMIT 1
ActiveRecord::SubclassNotFound: The single-table inheritance mechanism failed to locate the subclass: 'fuga'. This error is raised because the column 'type' is reserved for storing the class in case of inheritance. Please rename this column if you didn't intend it to be used for storing the inheritance class or overwrite Hoge.inheritance_column to use another column for that information.
</code></p>

<p>エラーメッセージから分かるように「type」というカラムをrenameしろと出ています<br/>
こんなの場合によっては出来無いわけで・・・</p>

<h3>これは何？</h3>

<hr />

<p>STI（単一テーブル継承）と呼ばれる機能のことを指しています<br/>
つまり、1つのテーブルを複数のModelで利用する仕組みのことを言います。</p>

<p>で、その仕掛けように予約語として、"type"という名前をActiveRecordが利用しているようです。</p>

<p>クラスで言うとこんなところでしょうか。<br/>
Humanクラスを継承した、Manクラス、Womanクラスがあったとした場合、以下のような形になります</p>

<p>```
class Human &lt; ActiveRecord::Base</p>

<p>end</p>

<p>class Man &lt; Human</p>

<p>end</p>

<p>class Woman &lt; Human</p>

<p>end
```</p>

<p>で、例えばManオブジェクトをsaveすると、Humanテーブルにtype:Manとして保存されます。<br/>
Womanならtype:Womanになるようです</p>

<p>それぞれのモデルからデータへの操作を行った場合、適合するTypeのデータのみを操作対象となります<br/>
ManもWomanも関係なく取得したい(両方をまとめて扱いたい)場合は、Humanモデルから操作すればOKです</p>

<p>当然ひとつのテーブルを使っていますので、片方にしか無い項目(カラム)もテーブルに含まなければならないです。<br/>
例えばManとHumanの持つ項目があまりにも違う場合、カラム数が爆発的に増えます。<br/>
(ここは注意するところですね)</p>

<h3>対処</h3>

<hr />

<p>もうざっくりというと、以下の2つの対応ができます</p>

<ol>
<li>カラム名に「type」という名前をつけず、別名に変更する</li>
<li>エラーメッセージにあるようにSTIのカラム名を変更する</li>
</ol>


<p>というわけなので、自分は1の対応を行いました。</p>

<p>では、2の場合はどうするかというと・・・
エラーメッセージにありますが、以下ように設定すればよいようです</p>

<p><code>
class Hoge &lt; ActiveRecord::Base
  self.inheritance_column = :_type_disabled
end
</code></p>

<h3>どういう場合に起きそう</h3>

<hr />

<p>ざっと思いつくのはこんなところかな</p>

<ul>
<li>既存のアプリケーション(PHPなりJavaなり)をRailsにのせかえるとき</li>
<li>設計上どうしても止むえずつけたいとき(これはビジネスドメインの場合が当てはまる)</li>
<li>(あんまりないと思うが)STIの機能を使ってリファクタリングするとき</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Railsのモデル周りのマイグレーション]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/06/21/rails-migration-command/"/>
    <updated>2015-06-21T14:15:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/06/21/rails-migration-command</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>Railsでmigrationするときにいつもアレなんだっけなぁとなることが多いので、<br/>
備忘録程度にまとめておく</p>

<p>こんなものドキュメント見れば理解できるので、ざっくりレベルのサマリー程度にしておく</p>

<h3>基本</h3>

<hr />

<p>マイグレーションファイル作成コマンド</p>

<p><code>
$rails generate migration クラス名
</code></p>

<p>モデル作成</p>

<p><code>
$rails generate model モデル名
</code></p>

<h3>モデル&amp;テーブル作成</h3>

<hr />

<p>フィールド指定で作成する場合、以下の形で行う<br/>
(大体はフィールド指定を行わずに、実行することが多いかも)</p>

<p><code>
$rails g model モデル名 フィールド:型
</code></p>

<h3>カラムの型指定</h3>

<hr />

<p>細かい調整をしようと思えばできるけど、一旦これだけ覚えておけば良い</p>

<table>
<thead>
<tr>
<th align="left">Ruby側の型 </th>
<th align="left"> DB側の型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> string </td>
<td align="left"> 文字列</td>
</tr>
<tr>
<td align="left"> text </td>
<td align="left"> 長い文字列</td>
</tr>
<tr>
<td align="left"> integer </td>
<td align="left"> 整数</td>
</tr>
<tr>
<td align="left"> float </td>
<td align="left"> 浮動小数</td>
</tr>
<tr>
<td align="left"> decimal </td>
<td align="left"> 精度の高い小数</td>
</tr>
<tr>
<td align="left"> datetime </td>
<td align="left"> 日時</td>
</tr>
<tr>
<td align="left"> timestamp </td>
<td align="left"> タイムスタンプ</td>
</tr>
<tr>
<td align="left"> time </td>
<td align="left"> 時間</td>
</tr>
<tr>
<td align="left"> date </td>
<td align="left"> 日付</td>
</tr>
<tr>
<td align="left"> binary </td>
<td align="left"> バイナリデータ</td>
</tr>
<tr>
<td align="left"> boolean </td>
<td align="left"> Boolean</td>
</tr>
</tbody>
</table>


<h3>(補足)MySQLで使用する場合の文字列型</h3>

<hr />

<p>MySQLで使用できる文字列型は以下が存在している</p>

<table>
<thead>
<tr>
<th align="left"> DB側の型 </th>
<th align="left"> 内容</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> CHAR </td>
<td align="left"> 255Bまでの固定長文字列</td>
</tr>
<tr>
<td align="left"> VARCHAR </td>
<td align="left"> 64KBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> TINYTEXT </td>
<td align="left"> 255Bまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> TEXT </td>
<td align="left"> 64KBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> MEDIUMTEXT </td>
<td align="left"> 約1.6MBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> LONGTEXT </td>
<td align="left"> 約4.3GBまでの可変長文字列</td>
</tr>
</tbody>
</table>


<p>上記をそれぞれmigrationで利用する場合<br/>
以下のようにlimitをつけることで、使用する文字列型を変更することができる</p>

<p>```
class CreateHoges &lt; ActiveRecord::Migration
  def change</p>

<pre><code>create_table :articles do |t|
  t.text :value, :limit =&gt; 4294967295

  t.timestamps null: false
end
</code></pre>

<p>  end
end
```</p>

<p>実行すると以下のようになる</p>

<p><code>
$ rails db
mysql&gt; show columns from hoges;
+-------------+--------------+------+-----+---------+----------------+
| Field       | Type         | Null | Key | Default | Extra          |
+-------------+--------------+------+-----+---------+----------------+
| id          | int(11)      | NO   | PRI | NULL    | auto_increment |
| value       | longtext     | YES  |     | NULL    |                |
| created_at  | datetime     | NO   |     | NULL    |                |
| updated_at  | datetime     | NO   |     | NULL    |                |
+-------------+--------------+------+-----+---------+----------------+
</code></p>

<p>limitの値は、以下のように対応している</p>

<table>
<thead>
<tr>
<th align="left"> 設定値 </th>
<th align="left"> DB側の型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> 1 ~ 255 </td>
<td align="left"> TINYTEXT</td>
</tr>
<tr>
<td align="left"> 256 ~ 65535 </td>
<td align="left"> TEXT</td>
</tr>
<tr>
<td align="left"> 65536 ~ 16777215 </td>
<td align="left"> MEDIUMTEXT</td>
</tr>
<tr>
<td align="left"> 16777216 ~ 4294967295 </td>
<td align="left"> LONGTEXT</td>
</tr>
</tbody>
</table>


<h3>マイグレーション実行</h3>

<hr />

<p>DB作成</p>

<p><code>
$rake db:create
</code></p>

<p>マイグレーションの実行</p>

<p><code>
$rake db:migrate
</code></p>

<p>マイグレーション結果確認</p>

<p><code>
$rake db:migrate:status
</code></p>

<p>ロールバック</p>

<p><code>
$rake db:rollback
</code></p>

<p>DBの削除</p>

<p><code>
$rake db:drop
</code></p>

<p>シードの投入(マスターデータなどシードで投入することが多い)</p>

<p><code>
$rake db:seed
</code></p>

<h3>既存カラムの変更</h3>

<hr />

<p>カラムを変更したい場合、以下のコマンドでマイグレーションファイルを生成する</p>

<p><code>
$rails g migration ChangeColumnTo&lt;モデル名&gt;
</code></p>

<p>変更は以下のような形で行う(upとdownを定義することでrollbackにも対応できる)</p>

<p>```
class ChangeColumnToYourModel&lt; ActiveRecord::Migration</p>

<p>  # 変更内容
  def up</p>

<pre><code>change_column :users, :hoge, :string, null: false, default: 0
</code></pre>

<p>  end</p>

<p>  # 変更前の状態
  def down</p>

<pre><code>change_column :users, :hoge, :string, null: true, default: 0
</code></pre>

<p>  end
end
```</p>

<p>気をつけることとして、change_columnは以下のような順で記載すること</p>

<p><code>
change_column :&lt;テーブル名&gt;, :&lt;カラム名&gt;, :&lt;型&gt;, &lt;default値やindexといったオプション指定&gt;
</code></p>

<h3>カラムの追加/削除</h3>

<hr />

<p>カラムの追加/削除をしたい場合、以下のコマンドでマイグレーションファイルを生成する<br/>
追加の場合は、フィールド指定可能</p>

<p><code>
$rails g migration AddColumnTo&lt;モデル&gt;
</code></p>

<p>以下のような形で記載する</p>

<p>```
class AddColumnToYourModel &lt; ActiveRecord::Migration
  def change</p>

<pre><code># 追加
add_column :hoges, :hoge, :string

# 削除
remove_column :hoges, :fuga, :string

# 追加する場所を指定する場合
add_column :hoges, :fugafuga, :string, :after =&gt; :hoge
</code></pre>

<p>  end
end
```</p>

<h3>インデックスの追加/削除</h3>

<hr />

<p>カラムの追加/削除と基本は変わらない</p>

<p><code>
$rails g migration AddIndexTo&lt;モデル&gt;
</code></p>

<p>以下のようにしてindexを設定する</p>

<p>```
class AddIndexToYourModel &lt; ActiveRecord::Migration
  def change</p>

<pre><code># 追加
add_index :hoges, :hoge

# 削除
remove_index :hoges, :fuga

# 複合インデックスの場合
add_index :hoges, [:hoge, :fuga]
</code></pre>

<p>  end
end
```</p>

<h3>参考</h3>

<hr />

<p>ここに書いてる内容は、Railsドキュメント見れば一発で理解できるけどな</p>

<ul>
<li><a href="http://railsdoc.com/model">モデル(model)</a></li>
<li><a href="http://railsdoc.com/migration">マイグレーション(migration)</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jQueryが見つからないよエラーの解消法]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2014/03/26/update-gemfile/"/>
    <updated>2014-03-26T23:32:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2014/03/26/update-gemfile</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>今更ながら、Rails3.2のアプリをRails4までアップデートしました。<br/>
そのとき出たエラーと解消方法を残します。</p>

<h3>当該のエラー</h3>

<hr />

<p>それがこれ</p>

<p><code>
couldn't find file 'jquery'
</code></p>

<p>正直、なんで？という感じ</p>

<h3>解消方法</h3>

<hr />

<p>Gemfileの記述が変わってたことが原因でした<br/>
(asset compile周りの仕様変更)</p>

<p>Rails3.x系は、Gemfileに以下がありました</p>

<p>```
group :assets do</p>

<p>ここにasset compileで使用するgemがある</p>

<p>end
```</p>

<p>ところが、Rails4系になるとasset groupは無くなる仕様に変わったみたいです。<br/>
代わりの設定は、<code>config/application.rb</code>になるようです。</p>

<p>メジャーアップデートの前に、<a href="http://railscasts.com/episodes/415-upgrading-to-rails-4?language=ja&amp;view=asciicast">移行ガイド</a>に目を通せってことですねw</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Railsで定数を定義する]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2014/03/23/rails-consts/"/>
    <updated>2014-03-23T20:34:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2014/03/23/rails-consts</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>Railsで定数を作るとき、いつもどうしてたっけ？っていう個人まとめをつくってみました。</p>

<p>決定版みたいなものが無い感じというのもあったりするので参照用という感じです。</p>

<h3>グローバルな定数定義</h3>

<hr />

<p>以下のような感じの内容で、「config/initializers」に適当なRubyファイルを作成して定義します</p>

<p><code>
HOGE = "HOGE"
FUGA = "FUGA"
</code></p>

<p>もしくは、yamlに定数を切り出して、実行タイミング(Rails起動時)にロードという方式でもいいかもしれません。<br/>
# yamlに切り出すと管理が大変になるかも・・・という欠点は無きにしもあらずですね。</p>

<p>欠点は以下が考えられます。</p>

<ul>
<li>namespaceの概念が無いので少々使いづらい</li>
<li>環境ごとに値を変更したい場合、切り替え処理を自前でやる必要がある</li>
</ul>


<p>特に、環境差分とか無ければこれでいいかもしれませんね。<br/>
# 尤も、namespaceを使わなくて済む程度という前提が付きますが・・・</p>

<h3>コントローラー内で共通な定数定義</h3>

<hr />

<p>以下のような感じで、app/controllers/application_controller.rb 内で定義します</p>

<p><code>
class ApplicationController &lt; ActionController::Base
  HOGE = "HOGE"
  FUGA = "FUGA"
end
</code></p>

<p>単にApplicationControllerがすべてのcontrollerのスーパークラスになっているから参照できるというだけの話です。
# あまりここに定義はしたくないですね。</p>

<h3>rails_configを使って環境ごとに変更する</h3>

<hr />

<p><a href="https://github.com/railsjedi/rails_config">rails_config</a>というgemを使う方法ですね。</p>

<p>以下をGemfileに記述し、インストールします。</p>

<p><code>
gem 'rails_config'
</code></p>

<p>rails_configを使うように初期設定をします(ただのインストールですが)
<code>
$rails g rails_config:install
</code></p>

<p>ファイルに関しては以下の通り</p>

<table>
<thead>
<tr>
<th align="left">環境</th>
<th align="left">ファイルパス</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">全ての環境で共通</td>
<td align="left">config/settings.yml</td>
</tr>
<tr>
<td align="left">ローカル環境</td>
<td align="left">config/settings.local.yml</td>
</tr>
<tr>
<td align="left">開発環境</td>
<td align="left">config/settings/development.yml</td>
</tr>
<tr>
<td align="left">テスト環境</td>
<td align="left">config/settings/test.yml</td>
</tr>
<tr>
<td align="left">本番環境</td>
<td align="left">config/settings/production.yml</td>
</tr>
</tbody>
</table>


<p>YAMLの記述は以下のような感じで行います</p>

<p><code>
hoge:
  fuga: 'fugafuga'
  test: 'test'
</code></p>

<p>使用する場合は、以下のようなコードで出来ます。</p>

<p><code>
Settings.hoge[:fuga]
Settings.hoge['fuga']
Settings[:hoge][:fuga]
</code></p>

<p>他に、同じようなことをする有名なgemに、「settingslogic」があります。<br/>
以下の感想でsettingslogicはあまりつかわないです。</p>

<ul>
<li>一つのファイルで全て定義なのでファイルが肥大化しそう</li>
<li>クラス定義も作る必要があるので若干面倒(シンプルに使えない)</li>
</ul>

]]></content>
  </entry>
  
</feed>
