<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[kurobaraのブログ]]></title>
  <link href="http://moonstruckdrops.github.com/atom.xml" rel="self"/>
  <link href="http://moonstruckdrops.github.com/"/>
  <updated>2016-02-07T01:31:18+09:00</updated>
  <id>http://moonstruckdrops.github.com/</id>
  <author>
    <name><![CDATA[kurobara]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[sshでX11 Forwardingをsudoコマンド時に実施する方法]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2016/02/07/sudo-and-x-and-ssh/"/>
    <updated>2016-02-07T01:11:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2016/02/07/sudo-and-x-and-ssh</id>
    <content type="html"><![CDATA[<h3>あったこと</h3>

<hr />

<p>表題のようにsshでX11 Forwardingでコマンドを実行したところ<br/>
下記のようなエラーになった</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -XY -l hoge xxx.xxx.xxx.xxx
</span><span class='line'>$ sudo virt-manager
</span><span class='line'>** (virt-manager:3166): WARNING **: Could not open X display
</span><span class='line'>X11 connection rejected because of wrong authentication.
</span><span class='line'>X11 connection rejected because of wrong authentication.
</span><span class='line'>(virt-manager:3166): Gtk-CRITICAL **: gtk_settings_get_for_screen: assertion 'GDK_IS_SCREEN (screen)' failed
</span><span class='line'>(virt-manager:3166): Gtk-CRITICAL **: _gtk_settings_get_style_cascade: assertion 'GTK_IS_SETTINGS (settings)' failed</span></code></pre></td></tr></table></div></figure>


<p>どうやら認可が正しくできていない模様<br/>
(GTKのSCREEN系のエラーっぽく見えるところが、ややこしさに拍車かけてると思う・・・)</p>

<h3>解決案</h3>

<hr />

<p>sudoコマンドを実行する際、Xauthorityを読み込むようにして実行する<br/>
(下記では、念の為xauthをインストールしている)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -XY -l hoge xxx.xxx.xxx.xxx
</span><span class='line'>$ sudo yum install xorg-x11-xauth
</span><span class='line'>$ sudo  XAUTHORITY=~/.Xauthority virt-manager</span></code></pre></td></tr></table></div></figure>


<p>強引に認可させているので、セキュリティ的に果たしてこれでいいのかという疑問は残りますね<br/>
何れにせよ、ローカルネットワーク内で実行するだけなのでこれでいいかなと。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GroovyでWALKMAN用のプレイリストコンバーターを作成した]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/12/30/walkman-playlist-converter/"/>
    <updated>2015-12-30T14:20:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/12/30/walkman-playlist-converter</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>自分の楽曲管理なのですが、以下で行っていました</p>

<ul>
<li>Macを使っている&amp;元iPhoneユーザーのためiTunes</li>
<li>現状はAndroidユーザーでXperiaZ3Compactを活用</li>
<li>iTunesとの連携にはiSyncrアプリでAndroidアプリを連携</li>
</ul>


<p>ここ最近、残念なことにXperiaZ3Compactのイヤホンジャックが故障してしまいました<br/>
海外版SIMFree版のため、国内で修理することもできません。</p>

<p>部品を調達してきて、別途修理するか悩みましたがリスクが高い<br/>
(ネットで調べる限りだいたい、何かしらミスしたという話が多かったです)</p>

<p>仕方ないのでWALKMANを調達するとして、以下の条件で機種が無いかをしらべました</p>

<ul>
<li>WALKMANであること</li>
<li>iSyncrアプリの恩恵を預かれること</li>
<li>microSDは活用してもいい</li>
<li>ある程度の運用は許容するので、何かしらのコンバーター(アプリorスクリプト)は実装してもよい</li>
</ul>


<p>条件に合致するものであれば・・・</p>

<ul>
<li>高額機種のWALKMAN</li>
<li>Android WALKMAN(3~4年前)で売り出していたFシリーズ</li>
<li>microSDが使用しているNW-A20シリーズ</li>
</ul>


<p>というわけで、機能面でも最新であることたお値段も含めて一番条件に合致するWALKMAN(NW-A25)を新たに新調することとしました<br/>
(Fシリーズは別途問題があったようなので却下にしました)</p>

<h3>何故コンバーターが必要になったか</h3>

<hr />

<p>iSyncrで作成したプレイリストは、Android向けに最適化されたもののようなので、そのままではNW-A25では活用することができませんでした<br/>
(店頭に通って挙動を確認しました)</p>

<p>症状としては以下のような形です</p>

<ul>
<li>プレイリストは認識するが曲が存在しない扱いとなる</li>
<li>プレイリストを通さない、ミュージック一覧では楽曲の認識と再生可能</li>
</ul>


<p>何故こういう状態が起こるかというと、WALKMANはOSがAndroidではない為、ファイルパスの扱いが異なるようです<br/>
なので、改善として以下のようにしてあげれば、プレイリストから楽曲再生ができるようになりました<br/>
(こちらも店頭で確認)</p>

<p><strong>変更前</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#EXTM3U
</span><span class='line'>/hoge/fuga.mp3
</span><span class='line'>/hoge/fugafuga.mp3</span></code></pre></td></tr></table></div></figure>


<p><strong>変更後</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#EXTM3U
</span><span class='line'>hoge/fuga.mp3
</span><span class='line'>hoge/fugafuga.mp3</span></code></pre></td></tr></table></div></figure>


<p>つまり、うまく認識させるためには相互変換できるようなものがあればよいということになります</p>

<h3>何故Groovy?</h3>

<hr />

<p>以下の打算があったので、Groovyでやってみました</p>

<ul>
<li>iSyncrはAndroidアプリなので、コンバーターもAndroidアプリでやれば運用が楽になるのではないか</li>
<li>AndroidはJavaで動作し、JVM言語であるGroovyが動作することも確認取れている</li>
<li>GroovyはJavaよりもライトに(Clojureを活用してですが)ファイル変更処理を実装することができる</li>
<li>ライトにできるので実装モック作成も割りと早めにできるのではないか</li>
</ul>


<p>が、結局Android上での外部ストレージ周りのファイル操作の挙動が変わってる(DocumentFileを通したファイル作成、変更がスクリプトと相性悪い為)ので<br/>
後述のスクリプト処理が活用しづらいのでアプリ内での変換処理は諦めました</p>

<p>なのでコマンドラインツールとして実装&amp;運用する方向としました<br/>
(運用できなくなるのが困るので、多少の労力(SDの抜き差し回数が増える)ぐらいなら労力を割いてもいい方向にしました)</p>

<h3>iSyncr向けのプレイリストからWALKMAN向けのプレイリストに変換</h3>

<hr />

<p>少し手間ですが、以下のような形をとりました</p>

<ol>
<li>WALKMAN向けのプレイリストファイルを作成する(この時点では一時ファイルとして)</li>
<li>iSyncr向けのプレイリストファイルを開く</li>
<li>iSyncr向けのプレイリストファイルの内容をWALKMAN向けのプレイリストファイルに書き込む</li>
<li>このとき行の先頭文字が<code>/</code>で始まっている場合、空文字に置換</li>
<li>ファイル名を正しいもの変更する</li>
<li>iSyncr向けプレイリストは、識別可能なファイル名に変更</li>
<li>一時ファイルのWALKMAN向けのプレイリストファイルは、正しいプレイリストファイル名になるよう変更</li>
</ol>


<p>これらを実装したものが以下になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def isyncrToWalkman() {
</span><span class='line'>  def sdCardDirPath = "/Volumes/WALKMAN/syncr"
</span><span class='line'>  def files = new File(sdCardDirPath).listFiles()
</span><span class='line'>
</span><span class='line'>  playList = files.findAll { it.getName() =~ /.*\.m3u$/ }
</span><span class='line'>  if (playList.empty) {
</span><span class='line'>    println "PlayList not found!"
</span><span class='line'>    return
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  playList.each { file -&gt;
</span><span class='line'>    def playListName = file.canonicalPath
</span><span class='line'>
</span><span class='line'>    def newPlayListName = "${file.canonicalPath}.new"
</span><span class='line'>    def newPlayListFile = new File(newPlayListName)
</span><span class='line'>
</span><span class='line'>    newPlayListFile.withWriter('UTF-8') { writer -&gt;
</span><span class='line'>      file.newReader().transformLine(writer) { line -&gt;
</span><span class='line'>        if (line.startsWith("/")){
</span><span class='line'>          line.replaceFirst(/\//,"")
</span><span class='line'>        } else {
</span><span class='line'>          line
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    file.renameTo("${file.canonicalPath}.isyncr")
</span><span class='line'>    newPlayListFile.renameTo("${playListName}")
</span><span class='line'>  }
</span><span class='line'>  println "Convert iSyncr To WALKMAN Complete!!"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>WALKMAN向けのプレイリストからiSyncr向けのプレイリストに変換</h3>

<hr />

<p>こちらは以下を実装するだけでよいので簡単です</p>

<ol>
<li>WALKMAN向けのプレイリストを削除</li>
<li>iSyncr用のプレイリストの名前を変更</li>
</ol>


<p>上記を実装したものが以下になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def walkmanToIsyncr() {
</span><span class='line'>  def sdCardDirPath = "/Volumes/WALKMAN/syncr"
</span><span class='line'>  def files = new File(sdCardDirPath).listFiles()
</span><span class='line'>
</span><span class='line'>  def isyncrPlayList = files.findAll { it.getName() =~ /.*\.m3u.isyncr$/ }
</span><span class='line'>  if (isyncrPlayList.empty) {
</span><span class='line'>    println "PlayList not found!"
</span><span class='line'>    return
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  def walkmanPlayList = files.findAll { it.getName() =~ /.*\.m3u$/ }
</span><span class='line'>  walkmanPlayList.each { file -&gt; file.delete() }
</span><span class='line'>
</span><span class='line'>  isyncrPlayList.each { file -&gt;
</span><span class='line'>    def name = file.canonicalPath.replaceFirst(/\.isyncr$/, "")
</span><span class='line'>    file.renameTo(name)
</span><span class='line'>  }
</span><span class='line'>  println "Convert WALKMAN TO iSyncr Complete!!"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>コマンドライン部分</h3>

<hr />

<p>こちらはGroovyのBuilderを実装している<code>CliBuilder</code>を活用しました
これは、コマンドラインから実行する際、どちらの変換を実行するかを選択させるようにしたかった為です。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def cli = new CliBuilder(usage:"PlayList Converter")
</span><span class='line'>cli.w("Playlist : iSyncr TO WALKMAN")
</span><span class='line'>cli.i("Playlist : WALKMAN TO iSyncr")
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>def opt = cli.parse(args)
</span><span class='line'>if (opt.w) {
</span><span class='line'>  isyncrToWalkman()
</span><span class='line'>  return
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>if (opt.i) {
</span><span class='line'>  walkmanToIsyncr()
</span><span class='line'>  return
</span><span class='line'>}
</span><span class='line'>cli.usage()</span></code></pre></td></tr></table></div></figure>


<p>コードみれば非常に簡単なのですが・・・</p>

<p>オプションに<code>w</code>を付けて実行すると、前述のiSyncrのプレイリストからWALKMAN向けのプレイリストに変換する処理を実施<br/>
オプションに<code>i</code>を付けて実行すると、前述のWALKMAN向けのプレイリストからiSyncrのプレイリストに変換する処理を実施<br/>
何もつけなければ、実行方法を表示するようになっています</p>

<h3>運用</h3>

<hr />

<p><strong>前提</strong></p>

<ol>
<li>PCが認識するSDカードのパスが<code>/Volume/WALKMAN</code>になるように設定</li>
<li>前述のコードをまとめたGroovyファイルを<code>playlist_converter.groovy</code>とする</li>
<li>sdkmanを使って、Groovyをインストール</li>
</ol>


<p><strong>運用手順</strong></p>

<ol>
<li>iSyncrでAndroid上のSDカードとプレイリストを同期</li>
<li>同期完了後、AndroidのSDカードを取外しPCにSDを接続</li>
<li>WALKMAN向けプレイリストになるように以下のコマンドで変換</li>
<li><code>$ groovy playlist_converter.groovy -w</code></li>
<li>WALKMANにSDカードをさして、ミュージックを楽しむ</li>
<li>WALKMANからSDを取り外し、PCにSDを接続</li>
<li>WALKMAN向けプレイリストになるように以下のコマンドで変換</li>
<li><code>$ groovy playlist_converter.groovy -i</code></li>
<li>AndroidにSDをさして、更にプレイリストの同期を実施</li>
</ol>


<p>少し煩雑な感じもしますが、手作業でプレイリストを修正するよりも多少マシかなぁと思ってます<br/>
(実際に自分は運用できてます)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AndroidでGroovyを使ってみる]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/12/20/android-groovy/"/>
    <updated>2015-12-20T23:38:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/12/20/android-groovy</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>現在常用のスマホとしてAndroid端末を使っています。<br/>
(つい半年前まではiPhoneを使っていました)</p>

<p>端末機としては海外版、XperiaZ3 Compactです。<br/>
(昨今の大型化している流れの中軽量かつ音楽プレイヤーとしても優れている機種として選定しました。)</p>

<p>元々iPhoneユーザーかつ環境が全てApple製品で統一されているので、音楽管理もiTunesで行っています。</p>

<p>そういう状況下であったので、iSyncrというアプリでiTunesのプレイリストと端末を同期させて利用していました</p>

<p>どうもXperiaZ3 Compact側のイヤホンジャック(ヘッドホンジャック)が壊れたようで、<br/>
音楽プレイヤーとしてはまともには利用できなくなりました</p>

<p>とはいえ、Youtubeを見て修理するのはリスクが高いのと、パーツが個人輸入になるので調達までのハードルが高いので修理方向は諦めました</p>

<p>が、どうも最近のwalkmanでは、microSDを使えプレイリストを少し調整すれば認識できるようなことを聞きつけました<br/>
(店頭モックでも、プレイリストを認識し再生可能であることを確認しました)<br/>
なので、microSDとの同期はiSyncrに任せ、同期したプレイリストの変更を独自のアプリでやればいいのではないかと思い今回やってみました</p>

<h3>やりたいこと</h3>

<hr />

<p>まずはiSyncrで作ったプレイリストがウォークマンから認識できるかどうかを確認しました。<br/>
結論的に言うとそのままでは不可能で、一旦編集が必要のようです。</p>

<p>どうやらiSyncrを使ってiTunesの曲を転送したときは、iSyncrの作ったm3uプレイリストを正しく認識出来ないようです<br/>
これは、ウォークマン側のプレイリスト内のパスの解釈の問題のようです。<br/>
対処方法としては、パスの先頭の「/」を削除することで認識させることできます<br/>
(ウォークマン内部では、パスが補完されているのかもしれませんがその辺りは不明です)</p>

<p>こんな感じになるようにします</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/hoge/fuga.mp3     -&gt; hoge/fuga.mp3
</span><span class='line'>/hoge/fugafuga.mp3 -&gt; hoge/fugafuga.mp3</span></code></pre></td></tr></table></div></figure>


<p>ということで実装としてやりたいことは至ってシンプルです</p>

<ul>
<li>編集後のプレイリストファイルを作成する</li>
<li>iSyncrで作成したプレイリストの内容を、ほぼそのまま編集後のプレイリストに書き込む</li>
<li>この時、行の最初の文字が「/」の場合、上記のように先頭の「/」を空文字に置換する</li>
</ul>


<h3>何故Groovy</h3>

<hr />

<p>Javaで書くと、以下の内容が面倒だったりするわけなのです</p>

<ul>
<li>StreamだとかWriterやらReaderやらでコード自体が肥大化、冗長化すること</li>
<li>ファイルの中身の操作や置換とか結構大変で面倒</li>
</ul>


<p>なので、今回その辺もサクッと実装できるGroovyで書いてみました</p>

<p>他にあるとすれば・・・</p>

<ul>
<li>GroovyがAndroidでも動くということ</li>
<li>置換検証用のコードをサクッと移植したかったこと</li>
<li>個人的にGroovyでコード書くというリハビリ(書かなくなって久しいので)</li>
</ul>


<h3>当該Groovyコード</h3>

<hr />

<p>やりたいことを実施するファイルの置換用コードは以下のようになります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def files = new File('Your Path').listFiles()
</span><span class='line'>playList = files.findAll { it.getName() =~ /.*\.m3u$/ }
</span><span class='line'>
</span><span class='line'>playList.each { file -&gt;
</span><span class='line'>  def playListName = file.canonicalPath
</span><span class='line'>
</span><span class='line'>  // 変更版プレイリスト
</span><span class='line'>  def newPlayListName = "${file.canonicalPath}.new"
</span><span class='line'>  def newPlayListFile = new File(newPlayListName)
</span><span class='line'>
</span><span class='line'>  // 変更版プレイリストに現行プレイリストの修正内容を出力
</span><span class='line'>  newPlayListFile.withWriter('UTF-8') { writer -&gt;
</span><span class='line'>    file.newReader().transformLine(writer) { line -&gt;
</span><span class='line'>      if (line.startsWith("/")){
</span><span class='line'>        // 行の最初の文字の場合、「/」を置換する
</span><span class='line'>        line.replaceFirst(/\//,"")
</span><span class='line'>      } else {
</span><span class='line'>        // それ以外の場合はそのまま出力
</span><span class='line'>        line
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  // ファイル名を変更する
</span><span class='line'>  file.renameTo("${file.canonicalPath}.old")
</span><span class='line'>  newPlayListFile.renameTo("${playListName}")
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>本当であれば上書き保存という形にしたいところですが、<br/>
元のファイルが無くなってしまうと今度は同期が取れなくなる可能性があるので別ファイルとしました</p>

<h3>GroovyをAndroidに導入</h3>

<hr />

<p>まずはGroovyのインストールをします。<br/>
以下のような形で<a href="http://sdkman.io/">sdkman</a>を使いましょう</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s http://get.sdkman.io | bash
</span><span class='line'>$ sdk ls groovy
</span><span class='line'>$ sdk install groovy 2.4.5
</span><span class='line'>$ sdk use groovy 2.4.5</span></code></pre></td></tr></table></div></figure>


<p>次にAndroidStudioでAndoridプロジェクトを用意します<br/>
Androidプロジェクトに対して、<a href="https://github.com/groovy/groovy-android-gradle-plugin">groovy-android-gradle-plugin</a>を導入します</p>

<p>プロジェクトROOTにあるbuild.gradleを以下のようにします<br/>
(プラグインを導入するのみです)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>buildscript {
</span><span class='line'>    repositories {
</span><span class='line'>        jcenter()
</span><span class='line'>    }
</span><span class='line'>    dependencies {
</span><span class='line'>        classpath 'com.android.tools.build:gradle:1.3.0'
</span><span class='line'>        classpath 'org.codehaus.groovy:gradle-groovy-android-plugin:0.3.6'
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>allprojects {
</span><span class='line'>    repositories {
</span><span class='line'>        jcenter()
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>task clean(type: Delete) {
</span><span class='line'>    delete rootProject.buildDir
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>次にアプリ側のbuild.gradleを変更します<br/>
(プラグインの適用と、コンパイルライブラリの追加、プラグインの設定追加)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apply plugin: 'com.android.application'
</span><span class='line'>apply plugin: 'groovyx.grooid.groovy-android'
</span><span class='line'>
</span><span class='line'>android {
</span><span class='line'>    中略
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>dependencies {
</span><span class='line'>    compile fileTree(dir: 'libs', include: ['*.jar'])
</span><span class='line'>    testCompile 'junit:junit:4.12'
</span><span class='line'>    compile 'com.android.support:appcompat-v7:23.1.1'
</span><span class='line'>    compile 'com.android.support:design:23.1.1'
</span><span class='line'>    compile 'org.codehaus.groovy:groovy:2.4.3:grooid'
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>project.androidGroovy {
</span><span class='line'>    options {
</span><span class='line'>        configure(groovyOptions) {
</span><span class='line'>            encoding = 'UTF-8'
</span><span class='line'>            forkOptions.jvmArgs = ['-noverify'] // maybe necessary if you use Google Play Services
</span><span class='line'>        }
</span><span class='line'>        sourceCompatibility = '1.7'
</span><span class='line'>        targetCompatibility = '1.7'
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ソースの配置を<code>「src/main/java/MainActivity.java」</code>から<code>「src/main/groovy/MainActivity.groovy」</code>変更します</p>

<p>最後にソースを以下のようにしてGroovyライクに実装します</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>@CompileStatic
</span><span class='line'>public class MainActivity extends AppCompatActivity {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    protected void onCreate(Bundle savedInstanceState) {
</span><span class='line'>        super.onCreate(savedInstanceState);
</span><span class='line'>        setContentView(R.layout.activity_main);
</span><span class='line'>
</span><span class='line'>        def hello = { lang -&gt;
</span><span class='line'>            def toast = Toast.makeText(this, "Hello ${lang}!", Toast.LENGTH_LONG)
</span><span class='line'>            toast.setGravity(Gravity.CENTER, 0, 0)
</span><span class='line'>            toast.show()
</span><span class='line'>        }
</span><span class='line'>        hello("Hello Groovy on Android!")
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>一応いっておきますが、@CompileStaticアノテーションで静的コンパイルしなくても動作はします<br/>
が、動的コードはパフォーマンス的にきびしいので@CompileStatic推奨されているようです</p>

<h3>ビルド時の注意点</h3>

<hr />

<p>Android Studioでビルドを実行したとき、エラーがあった場合以下のような形でEventLogに出力されてビルドが停止します。<br/>
メッセージを見ても、何が悪いか分かりません。正直、自分は困惑しました</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:52:06 Platform and Plugin Updates: The following components are ready to update: Google Play services, Google Repository, Android SDK Platform-tools
</span><span class='line'>1:14:33 Gradle sync started
</span><span class='line'>1:14:57 Gradle sync completed
</span><span class='line'>1:14:57 Executing tasks: [:app:generateDebugSources, :app:generateDebugAndroidTestSources]
</span><span class='line'>1:15:01 Gradle build finished in 4s 168ms
</span><span class='line'>1:15:41 Executing tasks: [:app:generateDebugSources, :app:generateDebugAndroidTestSources, :app:compileDebugSources, :app:compileDebugAndroidTestSources]
</span><span class='line'>1:15:47 ExternalSystemException: String index out of range: -105</span></code></pre></td></tr></table></div></figure>


<p>そのときはGradle Consoleを確認しましょう<br/>
以下のような形でエラーメッセージが表示されています<br/>
(この場合、Syntaxエラーですね)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:app:compileDebugJavaWithJavac UP-TO-DATE
</span><span class='line'>:app:compileDebugGroovyWithGroovyc
</span><span class='line'>startup failed:
</span><span class='line'>MainActivity.groovy: 53: expecting ')', found '}' @ line 53, column 13.
</span><span class='line'>               }
</span><span class='line'>               ^
</span><span class='line'>
</span><span class='line'>1 error
</span><span class='line'>
</span><span class='line'>
</span><span class='line'> FAILED
</span><span class='line'>
</span><span class='line'>FAILURE: Build failed with an exception.
</span><span class='line'>
</span><span class='line'>* What went wrong:
</span><span class='line'>Execution failed for task ':app:compileDebugGroovyWithGroovyc'.
</span><span class='line'>&gt; Compilation failed; see the compiler error output for details.
</span><span class='line'>
</span><span class='line'>* Try:
</span><span class='line'>Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.
</span><span class='line'>
</span><span class='line'>BUILD FAILED
</span><span class='line'>
</span><span class='line'>Total time: 5.687 secs</span></code></pre></td></tr></table></div></figure>


<p>因みに上記のような形になった場合、何故かそのままではビルドの再開が出来ませんでした。<br/>
対応としては一度「Clean Project」を実行する必要があります</p>

<h3>結果的に・・・</h3>

<hr />

<p>ここまで読めば、分かる方はわかりますが実現はサクッとは出来ませんでした。</p>

<p>何故かと言うとAndroid4.4あたりから導入された<a href="https://developer.android.com/intl/ja/guide/topics/providers/document-provider.html">Storage Access Framework</a>のことをスッカリ忘れていたのでやりたいことは出来ませんでしたorz</p>

<p>当初の運用自体は、iSyncrの同期先をSDカードにしてSDカードに対して同期<br/>
その後同期されたSDカードをPC側にマウントして、上記コードを通してやればよいので無理にAndroid経由させなくていいかなぁと思った次第です</p>

<p>とはいえGroovyでAndroidアプリを書いてみることはまぁできたのでよしとします。<br/>
GroovyでGroovy GDKの便利なAPIやクロージャの恩恵を最大限に受けてて、簡潔に書くことが出来て素晴らしいなと思いました</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyKaigi3日目に行ってきた]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/12/13/ruby-kaigi/"/>
    <updated>2015-12-13T11:24:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/12/13/ruby-kaigi</id>
    <content type="html"><![CDATA[<h3>The OMR GC Talk</h3>

<hr />

<p>OMRというランタイム</p>

<ul>
<li>多くの言語に対応している</li>
<li>(plugin機構で実現？)</li>
</ul>


<p>調査はこれを使っていた模様
https://www.ibm.com/developerworks/jp/java/library/j-ibmtools5/</p>

<p>allocationを早くした</p>

<ul>
<li>スレッドローカルヒープ</li>
<li>ロック無しでallocate</li>
</ul>


<p>可変長のバッファを作る
OMRのランタイム上で動作するGCがMRIに比べてよかった</p>

<p>GCのmark速度は早い(MRI)</p>

<p>OMR GCを確認するのはこれ
https://github.com/rubyomr-preview/rubyomr-preview</p>

<h3>Refinements - the Worst Feature You Ever Loved</h3>

<hr />

<p>method aliasとかモンキーパッチだと元の動きの振る舞いが全体に影響するからよくない</p>

<p>assertとかの振る舞いもかわってしまう</p>

<p>refinementsなら影響範囲を制御できる</p>

<p>スコープは働くので継承とかcalss_evalでも有効</p>

<p>文字列で与えたもので使えるeval &#8216;using SomeClass; hoge.fuga&#8217;みたいな感じなの</p>

<h3>Discussion on Thread between version 1.8.6 and 2.2.3</h3>

<hr />

<p>Thread#status
スレッドの状態が取れないような状況が起きた
→mission crtalなシステムでも使えるThreadの使い方</p>

<ul>
<li>子スレッドでforを同期的に上がった場合</li>
<li>同期的にraiseが上がった場合</li>
</ul>


<p>Ruby2.2.3でも早くなったけど、CPU負荷も上がった
実行回数は変わらなかった</p>

<p>raiseのインスタンスは重い
メモリ消費は少ない
selectで対応することができる</p>

<p>早くなったけど、リソース消費も多いのでスレッドとかはメモリ消費量を意識したほうがよい</p>

<h3>Plugin-based software design with Ruby and RubyGems</h3>

<hr />

<ul>
<li>多くの機能</li>
<li>コアコードがシンプル</li>
<li>testが簡単</li>
<li>developerコミュニティが活発</li>
</ul>


<p>デザインパターン</p>

<ol>
<li>ホストアプリを拡張する(拡張ポイントを用意している、コールバックで実行)</li>
<li>DIでプラグインを追加(I/Fとか決めてDIコンテナを置き換え、ホストからアプリを実行)</li>
<li>動的にプラグインをロードする方法</li>
<li>1と2を組み合わせる方法</li>
</ol>


<p>プラグインのバージョンコントロール(依存ライブラリのコンフリクト解消)</p>

<p>fluentdは動的にpluguin
emblukは組み合わせ</p>

<h3>Actor, Thread and me</h3>

<hr />

<p>アクター</p>

<ul>
<li>メッセージを適当なタイミングで送る</li>
<li>レシーブ</li>
<li>仕事をする</li>
</ul>


<p>破綻の予兆</p>

<ul>
<li>複数のイベントを待つ</li>
<li>DBへの問い合わせとか</li>
<li>資源の協調</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyKaigi2日目に行ってきた]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/12/12/ruby-kaigi/"/>
    <updated>2015-12-12T13:24:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/12/12/ruby-kaigi</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>RubyKaigi2日目に参加してきました。</p>

<p>気になるセッションもチラホラあり期待していました</p>

<p>ただ、盛大に寝坊しましたorz</p>

<p>という訳で、メモ</p>

<h3>Data Analytics Service Company and Its Ruby Usage</h3>

<hr />

<p>ミドルウェア
* データ処理をする上でスループットが重要
* 一度書いたものはそのまま運用されるので、固めにつくることが多い</p>

<p>集めてくるところとか、加工整形した結果などは固くつくる必要はない
(書捨ても多いから)</p>

<p>要素</p>

<ul>
<li>データを集めて保存</li>
<li>総うさするコンソr−るapi</li>
<li>データしゅべつ、型だとかのスキーマ管理</li>
<li>計算処理(batch,query)-> Java</li>
<li>キューイングやスケジュール処理</li>
<li>データを格納&amp;エクスポート</li>
</ul>


<p>キューとワーカーの話</p>

<p>perfedtsched(スケジューラー)
→SPOFのないcrontabと思えばよい
→1回も実行されないよりも２回実行されたほうがよい(別途担保が必要だが・・・)</p>

<p>リトライ可能かは、状況やエラー内容による
実行時間
jobの実行内容が重いものやら軽いものまで</p>

<p>perfectqueue(キュー)</p>

<ul>
<li>優先どの高いキューは高いものは素早く処理</li>
<li>graceful restart(字工事のjobは分離して実行)</li>
<li>RDBMSのようなinsertで実現</li>
<li>RDS(MySQL)を使ってる</li>
</ul>


<p>パフォーマンスコントロールとかでジョブ実行を制御している
安全側に倒している(顧客情報のisolationとか)</p>

<p>何故Rubyを使っているか</p>

<ul>
<li>ワーカーのコードが複雑だけど重要</li>
<li>テストが一番重要なので、書きやすいのでrspecを採用</li>
<li>テストコードの書きやすさが重要だった(可読性とか、オーバーライドとか)</li>
<li>新しい機能とか新しいライブラリは使っていく</li>
</ul>


<p>スケジューラーとキュー気になる</p>

<h3>Ruby for one day game programming camp for beginners</h3>

<hr />

<p>京大マイコンクラブで事例</p>

<p>Windowsの環境が殆どなので以下を実行するようにした</p>

<ul>
<li>Ruby1.8.4(starter kit)</li>
<li>MyGame and Ruby/SDL(ゲーム用)</li>
<li>sakura editor</li>
</ul>


<p>インストールして終わりぐらいの単純なものがよい</p>

<ul>
<li>講義みたいなことはしない</li>
<li>1対1のペアプロ</li>
<li>楽しいRubyが教本</li>
</ul>


<p>プログラム未経験の参加者の8割が大体できる
→やる気に繋がる
→自信によって自分が勉強する</p>

<p>考察してみる</p>

<ul>
<li>教えかたが勉強できる</li>
<li>つくるものが決まっている</li>
<li>締め切り</li>
<li>教えるものが少ない(基本的な制御構造)</li>
</ul>


<h3>Ruby and PostgreSQL, a love story</h3>

<hr />

<p>plmruby
zombodb</p>

<ul>
<li>producael language handler(他の言語のサポート)</li>
<li>indexがすぐれてる(通常indexだけなく、elastic searchとかのラッパーにもできる)</li>
<li>foreginData(他にデータが投げられる, csvなりなんなりにｄけいる)</li>
</ul>


<p>postgresql fdl</p>

<ul>
<li>callbackルーチンで駆動するライフサイクル(コールバックチェーンかな)</li>
<li>rubyがサポートする</li>
</ul>


<p>holycorn</p>

<h3>Rhebok, High Performance Rack Handler</h3>

<hr />

<p>Rhebok</p>

<ul>
<li>rack handler</li>
<li>unicorn比較で1.5x</li>
<li>gazelle(perlnのpluck)の置き換え</li>
</ul>


<p>使いドコロ</p>

<ul>
<li>高いトラフィックのあるところ</li>
<li>最適化が進んでるところに最適(SNS, gameとか)</li>
<li>rackがネックになったとき</li>
</ul>


<p>使えないところ</p>

<ul>
<li>websocket</li>
<li>streaming</li>
<li>リバースプロキシかまさないといけない</li>
</ul>


<p>性能</p>

<ul>
<li>http1.1(keepaliveは未サポート)</li>
<li>unix socket</li>
<li>ホットデプロイ可能</li>
<li>rackアプリの起動でOK</li>
</ul>


<p>Rack</p>

<ul>
<li>仕様(webserverとF/WをつなぐI/F)</li>
<li>middleware</li>
<li>Rack::Handlerの名前空間の下に同時実装をすれば自動認識できる</li>
</ul>


<p>パフォーマンス上げる</p>

<ul>
<li>マルチプロセス</li>
<li>マルチスレッド</li>
<li>IO多重化</li>
</ul>


<p>timeoutの実現</p>

<ul>
<li>IO.selectを使用する</li>
<li>pollを使うことで実現</li>
</ul>


<p>parser</p>

<ul>
<li>pico_http_parserに渡すように変更</li>
</ul>


<p>tcp</p>

<ul>
<li>tco_nodelayをオフにする</li>
<li>バッファリング遅延対策</li>
<li>tcpのやり取りが増えるのでフラグメンテーションいっぱい</li>
<li>書き込み回数を1回にしておく</li>
</ul>


<h3>Pragmatic Testing of Ruby Core</h3>

<p>テストを実行してみる
テストが落ちた報告をするといい</p>

<p>Makefleにテストがなく、common.mkにある
btest-ruby => bootstraptest
sample/test.rbが通った後に実行(runner.rb経由で実行)
make test-allなどは、標準ライブラリのテスト</p>

<p>make test-all TESTS=&#8221;-j4&#8221;すると並列で動く</p>

<p>test/ruby : 組み込み
test/logger : 添付ライブラリ
test/-ext- : C拡張</p>

<p>envutil.rb &lt;- ヤバイ
leakchecker.rb</p>

<p>rubyspecは現行の振る舞いだけしか書いてないので、
言語仕様ではない(by Matz)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ActiveRecord単体で使用した際に単一モデルにdefault_timezoneを設定する]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/12/12/ar-default-timezone/"/>
    <updated>2015-12-12T12:50:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/12/12/ar-default-timezone</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>DBアクセスがあるような検証用のプログラムを書いたりするときってActiveRecord便利ですよね</p>

<p>このとき、timezoneの設定がうまくいって無くてすごく嵌ったので備忘録代わりにメモしておきます</p>

<h3>設定方法</h3>

<hr />

<p>単純にこれだけです</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class TestModel &lt; ActiveRecord::Base
</span><span class='line'>  self.default_timezone = :local
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>もしくはこちらでもよいかと</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class TestModel &lt; ActiveRecord::Base
</span><span class='line'>  def self.default_timezone
</span><span class='line'>    :local
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>簡単でしたね</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyKaigi１日目に行ってきた]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/12/11/2015-ruby-kaigi/"/>
    <updated>2015-12-11T10:09:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/12/11/2015-ruby-kaigi</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>ここ最近はRubyを書くことが少なくなってきたのですが、<br/>
RubyKaigiの一日目に行ってきた</p>

<p>ミドルウェアとかインフラとか、設計とかコードから離れた生活を繰り広げております</p>

<p>RubyKaigiの一日目は、これまた時間と仕事の都合上午前中のみしか参加できずorz</p>

<p>なので、一日目は、keynoteだけ聞いてきました</p>

<p>Crystalにも興味はあったので、ちょっと気になるのですがここは涙を飲んで・・・</p>

<p>ところでマネーフォワードさん、すごいですね。</p>

<p>Rubyコミッターのフルタイム採用とか松田さんの技術顧問就任とか。</p>

<p>という訳でメモを残しておく</p>

<h3>keynote</h3>

<hr />

<p>プログラマーの美徳</p>

<ul>
<li>怠惰(怠けるための努力をしない)</li>
<li>ガマンしない(PCが活用されていないことに怒る)</li>
<li>傲慢(ソフトウェアのクォリティ)</li>
</ul>


<p>全て、怒りに通じている<br/>
(Rubyにケチ付けられていることも・・・)</p>

<p>怒りは伝染るので、親切も伝染る</p>

<p>なので、内心腹たってても親切に対応するといいことがある</p>

<p>親切な対応が多いので、Rubyコミュニティは素晴らしい</p>

<h4>最近のニュース</h4>

<ul>
<li>Ruby2.3.0リリースが出た(クリスマスにリリースする)</li>
<li>RubyKaigiに合わせてやった</li>
<li>もしかして機能をつけた(NameErrorの際にスペル指摘とか)</li>
<li>Enumerable#grep_vが追加(マッチしないものを提示)</li>
<li>Hash#fetch_at(指定しないキーがあれば例外)</li>
<li>Numeric#negative? positive?</li>
<li>Hashの包含関係をチェックできるようになった</li>
<li>Hash#to_proc(h= {1: 2,2: 4,4: 6} (1..3)..map(&amp;h))</li>
<li>Array,Hash#digメソッド追加(data.dig(:user, 0)のようにあればアクセスして値を返す)</li>
<li>ヒアドキュメントにチルダをつけると、インデントの浅いところに合わせる</li>
<li>frozen-string-literalをつけると、文字列に追加するとエラー、パフォーマンスがよくなる&amp;エラーがはっきりする</li>
<li>safe navigation オペレーター「&amp;.」の追加(ぼっちオペレーター・・・) u &amp;&amp; u.first &amp;&amp; u.name が u&amp;.first&amp;.name になる</li>
<li>年に5%~10%の改善(2.3も同様)</li>
</ul>


<p>よくなる提案を受け入れてもっと良い物をという、Rubyコミュニティの成果</p>

<ul>
<li>mruby1.2</li>
<li><p>ビルドプロセスとか、諸々の改善</p></li>
<li><p>Streem</p></li>
<li>githubに公開してた</li>
<li>何もしないのに取り上げられて、色々とバズってしまった</li>
</ul>


<h4>Ruby3</h4>

<ul>
<li>変化はコスト、苦痛</li>
<li>言語デザインは難しい</li>
<li>矛盾する要求がある</li>
</ul>


<p>未来の状況はわからない</p>

<p>スクリプト言語にオブジェクト指向要らない<br/>
→21世紀になってくると何らかの形でオブジェクト指向を持つものが多くなった<br/>
→人に合わせてつくることが無かった<br/>
新しい当たり前になれた<br/>
Ruby成功の秘訣<br/>
webappの分野ではトップ近くまでなれた<br/>
とはいえ、言語して完成しているわけではない</p>

<p>互換性の問題や、移行の問題(5年かかった)<br/>
# Python3よりはマシ</p>

<p>全部を捨てることはせず、段階的に変化させていく方法を取った<br/>
１つずつ、テストを書いて確認して実施<br/>
移行パスの提示</p>

<p>ドラスティックな変更はしないし、ひとつずつの進歩<br/>
バージョニング問題(1.8 vs 1.9のときは除くの轍は踏まなかった)は他の言語のようなことは起きなかった</p>

<p>変化のうえで学んだこと</p>

<ul>
<li>何もかもいっぺんに捨てない</li>
<li>劇的な変化はしない(互換性を理由なく捨ててはいけない)</li>
<li>変化を続ける</li>
<li>ユーザーへの利益(簡潔にかけるとか)</li>
</ul>


<p>Ruby3では以下をやりたい</p>

<ul>
<li>マルチコアへの対応(開発当時はシングルコアでマルチスレッド)</li>
<li>コードの拡大(主戦場が変った)</li>
<li>扱うデータ量の増加でのパフォーマンス対応</li>
</ul>


<p>こんな感じ(約束はしていない)</p>

<ul>
<li>アクターモデル(goroutin+channelも一応こちらに)</li>
<li>オーナーシップモデル</li>
<li>STM(software transaction)は難しいし、無理かも</li>
<li>streamモデル</li>
<li>pipeラインを使ったイベントループ(２番めのVMを動かすことで実現)</li>
<li>コンパイルを賢く</li>
<li>soft typing(flowtyped interfaceでFlow / Crystal言語、ある程度の型チェックDialyzar(Erlang))</li>
<li>3倍早くをパフォーマンスも目標にする(Ruby2.0よりも３倍)</li>
<li>2020までにRuby3を出したい・・・</li>
<li>難しいことに挑戦</li>
<li>メモリを大量に使うけど、消費量をおさえるようにはしたい</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails5を使ってみる]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/11/06/edge-rails5/"/>
    <updated>2015-11-06T00:16:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/11/06/edge-rails5</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>とある要件があり、使用するFramework最近ブログネタに賑わっているRailsでということになった<br/>
せっかくなので、開発開始&amp;リリースはいつになるのかという噂のRails5を使ってみることにした</p>

<p>開発変更時期にRails5もリリースされているだろうという多少の先を見越す形でもありますがｗ</p>

<h3>準備</h3>

<hr />

<p>どうやら、後方互換とはなんだったのかの勢いで最新っぽいので、以下を準備します。</p>

<ul>
<li>Ruby2.2.2以降のインストール</li>
<li>railsのリポジトリをclone</li>
</ul>


<p>なにはともあれ、現時点の最新版だとスッキリした気分ですねw</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$git clone https://github.com/rails/rails.git</span></code></pre></td></tr></table></div></figure>


<h3>まずはバージョン情報</h3>

<hr />

<p>昔は<code>railties/bin/rails</code>だったのですが、<code>railties/exe/rails</code>変更になったようです<br/>
ちょっと焦りましたw</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./rails/railties/exe/rails -v
</span><span class='line'>/usr/local/var/rbenv/versions/2.2.2/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require': cannot load such file -- concurrent/map (LoadError)
</span><span class='line'>  from /usr/local/var/rbenv/versions/2.2.2/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require'
</span><span class='line'>  from /Users/moonstruckdrops/rails/activesupport/lib/active_support/inflector/inflections.rb:1:in `&lt;top (required)&gt;'
</span><span class='line'>  from /usr/local/var/rbenv/versions/2.2.2/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require'
</span><span class='line'>  from /usr/local/var/rbenv/versions/2.2.2/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require'
</span><span class='line'>  from /Users/moonstruckdrops/rails/activesupport/lib/active_support/inflections.rb:1:in `&lt;top (required)&gt;'
</span><span class='line'>    (省略)</span></code></pre></td></tr></table></div></figure>


<p>どうやら、<code>activesupport/activesupport.gemspec</code>を見ると、<br/>
<code>concurrent-ruby</code>が足りなかったようなので追加します(正式版では無く、alpha版が必要です)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$gem install concurrent-ruby -v 1.0.0.pre5 --no-ri --no-rdoc</span></code></pre></td></tr></table></div></figure>


<p>気を取り直してもう一度実行すると動作します</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./rails/railties/exe/rails -v
</span><span class='line'>Rails 5.0.0.alpha</span></code></pre></td></tr></table></div></figure>


<h3>プロジェクト生成</h3>

<hr />

<p>せっかくなのでRails-APIオプションを使います<br/>
(api以外のオプションはお好みで設定してください)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./rails/railties/exe/rails new my_app --api -d mysql -T --skip-javascript --skip-test-unit --skip-turbolinks</span></code></pre></td></tr></table></div></figure>


<p>が、そのまま実行してもエラーになりますのでGemfileを修正します</p>

<ul>
<li><code>rails</code>は、cloneしたソースコードになるようにする</li>
<li><code>rack</code>,<code>arel</code>はgit or cloneしたソースコードになるようにする</li>
</ul>


<p>最終的にGemfileを以下のようにする(コメントのみ削除)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source 'https://rubygems.org'
</span><span class='line'>
</span><span class='line'>gem 'rack', path: '../rack'
</span><span class='line'>gem 'arel', path: '../arel'
</span><span class='line'>
</span><span class='line'>gem 'rails', '5.0.0.alpha', path: '../rails'
</span><span class='line'>gem 'mysql2', '&gt;= 0.3.18', '&lt; 0.5'
</span><span class='line'># gem 'bcrypt', '~&gt; 3.1.7'
</span><span class='line'>
</span><span class='line'># gem 'unicorn'
</span><span class='line'>
</span><span class='line'># gem 'capistrano-rails', group: :development
</span><span class='line'>
</span><span class='line'>gem 'active_model_serializers', '~&gt; 0.10.0.rc2'
</span><span class='line'>
</span><span class='line'># gem 'rack-cors'
</span><span class='line'>
</span><span class='line'>group :development, :test do
</span><span class='line'>  gem 'byebug'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>group :development do
</span><span class='line'>  gem 'spring'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>gem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw, :jruby]</span></code></pre></td></tr></table></div></figure>


<h3>起動する</h3>

<hr />

<p>ここは普段どおりにrackで起動します
rails</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cd my_app
</span><span class='line'>$bin/rails s
</span><span class='line'>=&gt; Booting WEBrick
</span><span class='line'>=&gt; Rails 5.0.0.alpha application starting in development on http://localhost:3000
</span><span class='line'>=&gt; Run `rails server -h` for more startup options
</span><span class='line'>=&gt; Ctrl-C to shutdown server
</span><span class='line'>[2015-11-06 00:00:05] INFO  WEBrick 1.3.1
</span><span class='line'>[2015-11-06 00:00:05] INFO  ruby 2.2.2 (2015-04-13) [x86_64-darwin14]
</span><span class='line'>[2015-11-06 00:00:05] INFO  WEBrick::HTTPServer#start: pid=14583 port=3000</span></code></pre></td></tr></table></div></figure>


<h3>ポイント</h3>

<hr />

<p>特に挙げることもないですが、
rails配下にあるgemspecファイルに目を通しておけば、インストールや起動に必須なgemがわかるので問題解決が早くなるということぐらいでしょうか</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Pythonで文字変換]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/10/24/unicode-escape/"/>
    <updated>2015-10-24T13:23:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/10/24/unicode-escape</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>AWSのLamdaを使ったのですが、どうも日本語が文字化けする形の模様<br/>
これをライトに解決したい<br/>
数が多いと使えないですが、少量の文字であれば直接Unicode Escapeする形にする</p>

<h3>やり方</h3>

<hr />

<p>Pythonの対話側インターフェースでライトに行う</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$python
</span><span class='line'>Python 2.7.10 (default, Jul 14 2015, 19:46:27)
</span><span class='line'>[GCC 4.2.1 Compatible Apple LLVM 6.0 (clang-600.0.39)] on darwin
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; s =  u'2015年春'
</span><span class='line'>&gt;&gt;&gt; s.encode('unicode_escape')
</span><span class='line'>'2015\\u5e74\\u6625'
</span><span class='line'>&gt;&gt;&gt; unicode('2015年春', 'UTF-8')
</span><span class='line'>u'2015\u5e74\u6625'
</span><span class='line'>&gt;&gt;&gt; exit
</span><span class='line'>Use exit() or Ctrl-D (i.e. EOF) to exit</span></code></pre></td></tr></table></div></figure>


<p>こんな感じ、別にAWS絡みではなくてもライトに使える</p>

<p>逆にデコードする場合、<code>s.decode('unicode-escape')</code>でできる</p>

<p>簡単ですね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GoogleMapで逆Geocodingをしたい]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/10/16/reverse-geocoding/"/>
    <updated>2015-10-16T11:08:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/10/16/reverse-geocoding</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>緯度と経度はわかるものの、住所がわからなくて困りまったことがありました。<br/>
特にGoogleMapのI/Fからは住所が導き出せなったので、ほとほと困り果てました。<br/>
ふと、その時ドキュメントを覗いたときに逆Geocodingができる記述があったのでやってみました。</p>

<h3>リクエストパラメータ</h3>

<hr />

<p>以下の表のように設定する</p>

<table>
<thead>
<tr>
<th align="left">パラメータ </th>
<th align="left"> 説明 </th>
<th align="left"> 指定方法 </th>
<th align="left"> 必須</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">address</td>
<td align="left">取得対象の住所</td>
<td align="left">テキスト</td>
<td align="left">latlngかどちらかを指定</td>
</tr>
<tr>
<td align="left">latlng</td>
<td align="left">取得対象の緯度軽度</td>
<td align="left">テキスト</td>
<td align="left">addressかどちらかを指定</td>
</tr>
<tr>
<td align="left">sensor</td>
<td align="left">位置センサーからのリクエストか</td>
<td align="left">boolean</td>
<td align="left">必ず指定する</td>
</tr>
<tr>
<td align="left">bounds</td>
<td align="left">ビューポートの境界ボックス(境界ボックスの南西と北東の角の緯度・経度で指定)</td>
<td align="left">テキスト</td>
<td align="left">  </td>
</tr>
<tr>
<td align="left">region</td>
<td align="left">地域コード(ccTLDの２文字)</td>
<td align="left">テキスト</td>
<td align="left">  </td>
</tr>
<tr>
<td align="left">language</td>
<td align="left">結果取得時の言語</td>
<td align="left">言語コード</td>
<td align="left">  </td>
</tr>
</tbody>
</table>


<p>boundsは以下のような形で指定する(緯度、経度がそれぞれどっちに向いてるのかを指定すると思えばよい)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>36.798805,-120.498805|136.733332,-130.498805</span></code></pre></td></tr></table></div></figure>


<h3>実行する</h3>

<p>以下のようにすることでjsonが返却される</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://maps.google.com/maps/api/geocode/json?latlng=36.798805,%20136.733332&sensor=false |jq .</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[unixtimestampをDatetimeに変更する]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/10/04/unixtime-to-datetime/"/>
    <updated>2015-10-04T12:54:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/10/04/unixtime-to-datetime</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>とあるログファイルを解析する必要があったわけなのですが<br/>
以下の状況のようなファイルでした</p>

<ul>
<li>中途半端にDateTimeが出力されている</li>
<li>但し、unixtimpstampであれば確実に出力されている</li>
</ul>


<p>なので、正確に発生日時を調べる必要が出てきました</p>

<h3>変換コマンド</h3>

<hr />

<p>Linuxの場合であれば、以下を実行するだけなのでそんなに難しくない</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ date --date '@1443883848'
</span><span class='line'>2015年 10月  3日 土曜日 23:50:48 JST</span></code></pre></td></tr></table></div></figure>


<p>Macの場合であれば、Homebrewで<code>coreutils</code>をインストールしてあれば以下を実行するだけ
(以下のような形でフォーマットの設定が必要ですが・・・)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gdate --date '@1443883848' +'%Y/%m/%d %H:%M'
</span><span class='line'>2015/10/03 23:50</span></code></pre></td></tr></table></div></figure>


<p>ログ解析用のバッチにこのコマンドを仕掛ければ簡単に使えそうですね</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[deviseでemailを空白でもよいようにする]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/08/10/devise-email/"/>
    <updated>2015-08-10T10:22:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/08/10/devise-email</id>
    <content type="html"><![CDATA[<h3>やりたいこと</h3>

<hr />

<p>以下の２つを実現したい</p>

<ul>
<li>ユーザー登録した場合はemailの入力は不要</li>
<li>ユーザー情報編集時、emailが空文字でも、uniqueバリデーションに引っかからないよう</li>
<li>ただし、uniqueは別なもので担保</li>
</ul>


<h3>対応方法</h3>

<hr />

<ol>
<li>indexの削除</li>
<li>別のものでuniqueを担保</li>
<li>email判定のロジック箇所をオーバライド</li>
</ol>


<h3>indexの削除</h3>

<hr />

<p>以下のコマンドでマイグレーション用ファイルを作成する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration remove_index_email_from_users</span></code></pre></td></tr></table></div></figure>


<p>以下のように実装し、migrationを実行する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RemoveIndexEmailFromUsers &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    remove_index :users, column: :email, unique: true
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>別のものでuniqueを担保</h3>

<hr />

<p>こちらは普通にunique制約と<code>validates_uniqueness_of</code>を付与するのみ</p>

<p>とりあえずunique制約のみ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration add_index_item_from_users</span></code></pre></td></tr></table></div></figure>


<p>以下のような形でunique制約をつける</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddIndexItemFromUsers &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    add_index :users, :item, unique: true
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>こんな感じにしておく</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  validates_uniqueness_of :item
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>email判定のロジック箇所をオーバライド</h3>

<hr />

<p>emailカラムには<a href="https://github.com/plataformatec/devise/blob/c179cef365f7188c91cbbc3db924a9f1f9563c3c/lib/devise/models/validatable.rb#L29">バリデーションが設定されている</a>ので、<br/>
これをオーバライドすることでバリデーション周りの挙動を変更できる</p>

<p><a href="https://github.com/plataformatec/devise/blob/c179cef365f7188c91cbbc3db924a9f1f9563c3c/lib/devise/models/validatable.rb#L58">判定箇所を追いかける</a>と、デフォルトで有効になっているのでここをfalseに変更する</p>

<p>こんな感じにしておく</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  def email_required?
</span><span class='line'>    false
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>勿論、状況によって<code>email_required?</code>が必要なこともあるのでここは要仕様検討というところでしょうか。</p>

<p>当たり前ですが、デカイライブラリなので、ちょっとしたことをやるだけでも結構ややこし目の実装だったりソースを読むことが必須になりますね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RailsでSTI（単一テーブル継承）の予約語でハマった話対処]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/06/27/rails-sti/"/>
    <updated>2015-06-27T11:38:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/06/27/rails-sti</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>ここ数日、自分用のアプリを作っているわけなのですが<br/>
その時に起きたエラーを記載しておきます</p>

<p>(STIの予約語のこと忘れてたというオチｗ)</p>

<h3>事象</h3>

<hr />

<p>ActiveRecordで「type」というカラムをもつテーブルに接続し、取得系のメソッドを呼ぶと以下の様なエラーが出た</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1] pry(main)&gt; Hoge.find(1)
</span><span class='line'>  Hoge Load (0.4ms)  SELECT `hoges`.* FROM `hoges` WHERE `hoges`.`id` = 1 LIMIT 1
</span><span class='line'>ActiveRecord::SubclassNotFound: The single-table inheritance mechanism failed to locate the subclass: 'fuga'. This error is raised because the column 'type' is reserved for storing the class in case of inheritance. Please rename this column if you didn't intend it to be used for storing the inheritance class or overwrite Hoge.inheritance_column to use another column for that information.</span></code></pre></td></tr></table></div></figure>


<p>エラーメッセージから分かるように「type」というカラムをrenameしろと出ています<br/>
こんなの場合によっては出来無いわけで・・・</p>

<h3>これは何？</h3>

<hr />

<p>STI（単一テーブル継承）と呼ばれる機能のことを指しています<br/>
つまり、1つのテーブルを複数のModelで利用する仕組みのことを言います。</p>

<p>で、その仕掛けように予約語として、&#8221;type&#8221;という名前をActiveRecordが利用しているようです。</p>

<p>クラスで言うとこんなところでしょうか。<br/>
Humanクラスを継承した、Manクラス、Womanクラスがあったとした場合、以下のような形になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Human &lt; ActiveRecord::Base
</span><span class='line'>
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class Man &lt; Human
</span><span class='line'>
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class Woman &lt; Human
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>で、例えばManオブジェクトをsaveすると、Humanテーブルにtype:Manとして保存されます。<br/>
Womanならtype:Womanになるようです</p>

<p>それぞれのモデルからデータへの操作を行った場合、適合するTypeのデータのみを操作対象となります<br/>
ManもWomanも関係なく取得したい(両方をまとめて扱いたい)場合は、Humanモデルから操作すればOKです</p>

<p>当然ひとつのテーブルを使っていますので、片方にしか無い項目(カラム)もテーブルに含まなければならないです。<br/>
例えばManとHumanの持つ項目があまりにも違う場合、カラム数が爆発的に増えます。<br/>
(ここは注意するところですね)</p>

<h3>対処</h3>

<hr />

<p>もうざっくりというと、以下の2つの対応ができます</p>

<ol>
<li>カラム名に「type」という名前をつけず、別名に変更する</li>
<li>エラーメッセージにあるようにSTIのカラム名を変更する</li>
</ol>


<p>というわけなので、自分は1の対応を行いました。</p>

<p>では、2の場合はどうするかというと・・・
エラーメッセージにありますが、以下ように設定すればよいようです</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Hoge &lt; ActiveRecord::Base
</span><span class='line'>  self.inheritance_column = :_type_disabled
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>どういう場合に起きそう</h3>

<hr />

<p>ざっと思いつくのはこんなところかな</p>

<ul>
<li>既存のアプリケーション(PHPなりJavaなり)をRailsにのせかえるとき</li>
<li>設計上どうしても止むえずつけたいとき(これはビジネスドメインの場合が当てはまる)</li>
<li>(あんまりないと思うが)STIの機能を使ってリファクタリングするとき</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Railsのモデル周りのマイグレーション]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/06/21/rails-migration-command/"/>
    <updated>2015-06-21T14:15:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/06/21/rails-migration-command</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>Railsでmigrationするときにいつもアレなんだっけなぁとなることが多いので、<br/>
備忘録程度にまとめておく</p>

<p>こんなものドキュメント見れば理解できるので、ざっくりレベルのサマリー程度にしておく</p>

<h3>基本</h3>

<hr />

<p>マイグレーションファイル作成コマンド</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails generate migration クラス名</span></code></pre></td></tr></table></div></figure>


<p>モデル作成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails generate model モデル名</span></code></pre></td></tr></table></div></figure>


<h3>モデル&amp;テーブル作成</h3>

<hr />

<p>フィールド指定で作成する場合、以下の形で行う<br/>
(大体はフィールド指定を行わずに、実行することが多いかも)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g model モデル名 フィールド:型</span></code></pre></td></tr></table></div></figure>


<h3>カラムの型指定</h3>

<hr />

<p>細かい調整をしようと思えばできるけど、一旦これだけ覚えておけば良い</p>

<table>
<thead>
<tr>
<th align="left">Ruby側の型 </th>
<th align="left"> DB側の型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> string </td>
<td align="left"> 文字列</td>
</tr>
<tr>
<td align="left"> text </td>
<td align="left"> 長い文字列</td>
</tr>
<tr>
<td align="left"> integer </td>
<td align="left"> 整数</td>
</tr>
<tr>
<td align="left"> float </td>
<td align="left"> 浮動小数</td>
</tr>
<tr>
<td align="left"> decimal </td>
<td align="left"> 精度の高い小数</td>
</tr>
<tr>
<td align="left"> datetime </td>
<td align="left"> 日時</td>
</tr>
<tr>
<td align="left"> timestamp </td>
<td align="left"> タイムスタンプ</td>
</tr>
<tr>
<td align="left"> time </td>
<td align="left"> 時間</td>
</tr>
<tr>
<td align="left"> date </td>
<td align="left"> 日付</td>
</tr>
<tr>
<td align="left"> binary </td>
<td align="left"> バイナリデータ</td>
</tr>
<tr>
<td align="left"> boolean </td>
<td align="left"> Boolean</td>
</tr>
</tbody>
</table>


<h3>(補足)MySQLで使用する場合の文字列型</h3>

<hr />

<p>MySQLで使用できる文字列型は以下が存在している</p>

<table>
<thead>
<tr>
<th align="left"> DB側の型 </th>
<th align="left"> 内容</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> CHAR </td>
<td align="left"> 255Bまでの固定長文字列</td>
</tr>
<tr>
<td align="left"> VARCHAR </td>
<td align="left"> 64KBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> TINYTEXT </td>
<td align="left"> 255Bまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> TEXT </td>
<td align="left"> 64KBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> MEDIUMTEXT </td>
<td align="left"> 約1.6MBまでの可変長文字列</td>
</tr>
<tr>
<td align="left"> LONGTEXT </td>
<td align="left"> 約4.3GBまでの可変長文字列</td>
</tr>
</tbody>
</table>


<p>上記をそれぞれmigrationで利用する場合<br/>
以下のようにlimitをつけることで、使用する文字列型を変更することができる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CreateHoges &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    create_table :articles do |t|
</span><span class='line'>      t.text :value, :limit =&gt; 4294967295
</span><span class='line'>
</span><span class='line'>      t.timestamps null: false
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>実行すると以下のようになる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails db
</span><span class='line'>mysql&gt; show columns from hoges;
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+
</span><span class='line'>| Field       | Type         | Null | Key | Default | Extra          |
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+
</span><span class='line'>| id          | int(11)      | NO   | PRI | NULL    | auto_increment |
</span><span class='line'>| value       | longtext     | YES  |     | NULL    |                |
</span><span class='line'>| created_at  | datetime     | NO   |     | NULL    |                |
</span><span class='line'>| updated_at  | datetime     | NO   |     | NULL    |                |
</span><span class='line'>+-------------+--------------+------+-----+---------+----------------+</span></code></pre></td></tr></table></div></figure>


<p>limitの値は、以下のように対応している</p>

<table>
<thead>
<tr>
<th align="left"> 設定値 </th>
<th align="left"> DB側の型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> 1 ~ 255 </td>
<td align="left"> TINYTEXT</td>
</tr>
<tr>
<td align="left"> 256 ~ 65535 </td>
<td align="left"> TEXT</td>
</tr>
<tr>
<td align="left"> 65536 ~ 16777215 </td>
<td align="left"> MEDIUMTEXT</td>
</tr>
<tr>
<td align="left"> 16777216 ~ 4294967295 </td>
<td align="left"> LONGTEXT</td>
</tr>
</tbody>
</table>


<h3>マイグレーション実行</h3>

<hr />

<p>DB作成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:create</span></code></pre></td></tr></table></div></figure>


<p>マイグレーションの実行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:migrate</span></code></pre></td></tr></table></div></figure>


<p>マイグレーション結果確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:migrate:status</span></code></pre></td></tr></table></div></figure>


<p>ロールバック</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:rollback</span></code></pre></td></tr></table></div></figure>


<p>DBの削除</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:drop</span></code></pre></td></tr></table></div></figure>


<p>シードの投入(マスターデータなどシードで投入することが多い)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rake db:seed</span></code></pre></td></tr></table></div></figure>


<h3>既存カラムの変更</h3>

<hr />

<p>カラムを変更したい場合、以下のコマンドでマイグレーションファイルを生成する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration ChangeColumnTo&lt;モデル名&gt;</span></code></pre></td></tr></table></div></figure>


<p>変更は以下のような形で行う(upとdownを定義することでrollbackにも対応できる)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ChangeColumnToYourModel&lt; ActiveRecord::Migration
</span><span class='line'>
</span><span class='line'>  # 変更内容
</span><span class='line'>  def up
</span><span class='line'>    change_column :users, :hoge, :string, null: false, default: 0
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  # 変更前の状態
</span><span class='line'>  def down
</span><span class='line'>    change_column :users, :hoge, :string, null: true, default: 0
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>気をつけることとして、change_columnは以下のような順で記載すること</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>change_column :&lt;テーブル名&gt;, :&lt;カラム名&gt;, :&lt;型&gt;, &lt;default値やindexといったオプション指定&gt;</span></code></pre></td></tr></table></div></figure>


<h3>カラムの追加/削除</h3>

<hr />

<p>カラムの追加/削除をしたい場合、以下のコマンドでマイグレーションファイルを生成する<br/>
追加の場合は、フィールド指定可能</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration AddColumnTo&lt;モデル&gt;</span></code></pre></td></tr></table></div></figure>


<p>以下のような形で記載する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddColumnToYourModel &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>
</span><span class='line'>    # 追加
</span><span class='line'>    add_column :hoges, :hoge, :string
</span><span class='line'>
</span><span class='line'>    # 削除
</span><span class='line'>    remove_column :hoges, :fuga, :string
</span><span class='line'>
</span><span class='line'>    # 追加する場所を指定する場合
</span><span class='line'>    add_column :hoges, :fugafuga, :string, :after =&gt; :hoge
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>インデックスの追加/削除</h3>

<hr />

<p>カラムの追加/削除と基本は変わらない</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$rails g migration AddIndexTo&lt;モデル&gt;</span></code></pre></td></tr></table></div></figure>


<p>以下のようにしてindexを設定する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class AddIndexToYourModel &lt; ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>
</span><span class='line'>    # 追加
</span><span class='line'>    add_index :hoges, :hoge
</span><span class='line'>
</span><span class='line'>    # 削除
</span><span class='line'>    remove_index :hoges, :fuga
</span><span class='line'>
</span><span class='line'>    # 複合インデックスの場合
</span><span class='line'>    add_index :hoges, [:hoge, :fuga]
</span><span class='line'>
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>参考</h3>

<hr />

<p>ここに書いてる内容は、Railsドキュメント見れば一発で理解できるけどな</p>

<ul>
<li><a href="http://railsdoc.com/model">モデル(model)</a></li>
<li><a href="http://railsdoc.com/migration">マイグレーション(migration)</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[テーブル単位のmysqldump]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/05/06/mysqldump/"/>
    <updated>2015-05-06T23:39:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/05/06/mysqldump</id>
    <content type="html"><![CDATA[<h2>めちゃくちゃ基礎的な内容なのですが、備忘録を兼ねてメモしておく</h2>

<h3>DBまるごと</h3>

<p>よくやるmysqldumpコマンド</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$mysqldump -u root -p development_db  &gt; db_backup.sql</span></code></pre></td></tr></table></div></figure>


<h3>テーブル単位</h3>

<p>tオプションは、「テーブル作成情報（CREATE TABLE ステートメント）を書き込まない」という内容を指す<br/>
migrationなどで先にテーブルを作った場合とかに有効活用できる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$mysqldump -u root -p -t development_db my_table1 my_table2 &gt; table_backup.sql</span></code></pre></td></tr></table></div></figure>


<p>上のコマンドのようにテーブル名は複数指定可能(my_table1, my_table2などが該当)</p>

<h3>リストア</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$mysql -u root -p development_db &lt; summaries.sql</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BuildConfigを使用して、環境ごとに値を取得仕分けてみる]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/03/17/android-build-config/"/>
    <updated>2015-03-17T23:57:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/03/17/android-build-config</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>WebAPIと連携するようなAndroidアプリを作っているのですが
開発と本番で接続先を切り替える必要が出てきました。</p>

<p>それのライトな対応方法をメモ</p>

<h3>build.gradleを編集</h3>

<hr />

<p>以下のような形で記載</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>buildTypes {
</span><span class='line'>  debug {
</span><span class='line'>    buildConfigField "String", "API_URL", "\"http://api-dev.hoge.co.jp\""
</span><span class='line'>  }
</span><span class='line'>  release {
</span><span class='line'>    buildConfigField "String", "API_URL", "\"http://api.hoge.co.jp\""
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>ソースコード側</h3>

<hr />

<p>以下のように特に気にせずBuildConfigを参照すればよい</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>String url = BuildConfig.API_URL</span></code></pre></td></tr></table></div></figure>


<p>ビルド環境に応じた値が取得できる</p>

<h3>できたけど・・・</h3>

<hr />

<p>これぐらいなら、まぁbuild.gradleでいいやという気がするもののパラメータ増えたら収拾つかなくなる予感</p>

<p>真面目にやるならBuild Variantsを使うほうがよいかと思います</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Heroku上でJersey + Jetty + Gradleを動かす]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/03/17/jersey-on-heroku/"/>
    <updated>2015-03-17T01:14:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/03/17/jersey-on-heroku</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>JavaでRestfulといえば、JAX-RSが有名ですね。</p>

<p>それを扱いやすくしたFrameworkといえば、<a href="https://jersey.java.net/">Jersey</a>になります。<br/>
これをHerokuで動かすようにしてみます。</p>

<p>ついでにオワコン臭漂うmavenを辞めて、Gradleでビルドができるようにもしてみます</p>

<h3>目標</h3>

<hr />

<p>以下ができていること</p>

<ul>
<li>Heroku上でJerseyが動くこと</li>
<li>HerokuではJettyがサーブレット・コンテナとして動くこと</li>
<li>ビルドツールには、デフォルトのmavenではなくGradleであること</li>
</ul>


<h3>Jersey</h3>

<hr />

<p>まずはmaven ArchTypeから必要なファイルを準備</p>

<p><a href="https://jersey.java.net/download.html">ここ</a>を参考にすると、ArchTypeは2種類あることが分かります。</p>

<p>今回はJettyで動かすので、サーブレットコンテナ用のものを使います</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn archetype:generate -DarchetypeGroupId=org.glassfish.jersey.archetypes -DarchetypeArtifactId=jersey-quickstart-webapp -DarchetypeVersion=2.17</span></code></pre></td></tr></table></div></figure>


<p>必要項目を聞かれますので、以下のような感じで入力していきます</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Define value for property 'groupId': : kurobara
</span><span class='line'>Define value for property 'artifactId': : kurobara
</span><span class='line'>Define value for property 'version': 1.0-SNAPSHOT:
</span><span class='line'>Define value for property 'package': kurobara: kurobara</span></code></pre></td></tr></table></div></figure>


<p>成功すれば、以下の構成になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── pom.xml
</span><span class='line'>├── src
</span><span class='line'>│   └── main
</span><span class='line'>│       ├── java
</span><span class='line'>│       │   └── kurobara
</span><span class='line'>│       │       └── MyResource.java
</span><span class='line'>│       ├── resources
</span><span class='line'>│       └── webapp
</span><span class='line'>│           ├── WEB-INF
</span><span class='line'>│           │   └── web.xml
</span><span class='line'>│           └── index.jsp</span></code></pre></td></tr></table></div></figure>


<h3>mavenの削除</h3>

<hr />

<p>普通に考えると、mavenを使わなければpom.xmlを残してもよいかと思います(自分も最初は思いました)
Herokuではmavenがデフォルトで使われますので、削除してしまいます</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rm pom.xml</span></code></pre></td></tr></table></div></figure>


<p>どうやら、mavenとGradleの両方のビルドファイルが存在するとHerokuではmavenのものが最優先で使われるようです</p>

<h3>Gradleの追加</h3>

<hr />

<p>以下の内容を<code>build.gradle</code>に記載します</p>

<p>このファイルのミソは<code>task stage(dependsOn: ['clean', 'installApp'])</code>を記載していることです。
Herokuではこのタスクが必要なようです。</p>

<p><a href="https://github.com/heroku/devcenter-gradle">公式</a>を参考にしました。</p>

<p>多分、必要無いと思いますが念のためgradlewも用意しました(自分は一応、これもファイルに追加しています)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apply plugin: "java"
</span><span class='line'>apply plugin: "war"
</span><span class='line'>apply plugin: "jetty"
</span><span class='line'>apply plugin: 'application'
</span><span class='line'>
</span><span class='line'>group = "kurobara"
</span><span class='line'>version = 1.0
</span><span class='line'>sourceCompatibility = 1.7
</span><span class='line'>mainClassName = "kurobara"
</span><span class='line'>applicationName = "kurobara"
</span><span class='line'>
</span><span class='line'>def defaultEncoding = 'UTF-8'
</span><span class='line'>[
</span><span class='line'>  compileJava,
</span><span class='line'>  compileTestJava,
</span><span class='line'>  javadoc
</span><span class='line'>]*.options*.encoding = defaultEncoding
</span><span class='line'>
</span><span class='line'>repositories {
</span><span class='line'>  mavenLocal()
</span><span class='line'>  maven { url "http://maven.seasar.org/maven2" }
</span><span class='line'>  mavenCentral()
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>dependencies {
</span><span class='line'>  compile 'org.eclipse.jetty:jetty-server:9.2.10.v20150310'
</span><span class='line'>  compile 'org.eclipse.jetty:jetty-webapp:9.2.10.v20150310'
</span><span class='line'>  compile 'org.glassfish.jersey.core:jersey-server:2.17'
</span><span class='line'>  compile 'org.glassfish.jersey.containers:jersey-container-servlet-core:2.17'
</span><span class='line'>
</span><span class='line'>  testCompile 'junit:junit:4.10'
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>task stage(dependsOn: ['clean', 'installApp'])
</span><span class='line'>
</span><span class='line'>[jettyRun, jettyRunWar]*.httpPort = 8090
</span><span class='line'>[jettyRun, jettyRunWar]*.contextPath = 'kurobara'
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>task wrapper(type: Wrapper) {
</span><span class='line'>  gradleVersion = '1.6'
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Jettyの準備</h3>

<hr />

<p>最低限度の内容でJettyサーバが動くようにします</p>

<p>mainメソッドにサーバの実装を記載します。</p>

<p>Gradleに記載したように、これがmainClassになります(mainClassNameを参照)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import org.eclipse.jetty.server.Server;
</span><span class='line'>import org.eclipse.jetty.webapp.WebAppContext;
</span><span class='line'>
</span><span class='line'>public class Main {
</span><span class='line'>
</span><span class='line'>  public static void main(String[] args) throws Exception {
</span><span class='line'>      Server server = new Server(Integer.valueOf(System.getenv("PORT")));
</span><span class='line'>
</span><span class='line'>      WebAppContext context = new WebAppContext();
</span><span class='line'>      context.setServer(server);
</span><span class='line'>      context.setContextPath("/");
</span><span class='line'>      context.setResourceBase("src/main/webapp");
</span><span class='line'>      context.setClassLoader(Main.class.getClassLoader());
</span><span class='line'>      server.setHandler(context);
</span><span class='line'>
</span><span class='line'>      server.start();
</span><span class='line'>      server.join();
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>以下の構成になるようにMainクラスを配置します</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── build.gradle
</span><span class='line'>├── src
</span><span class='line'>│   └── main
</span><span class='line'>│       ├── java
</span><span class='line'>│       │   └── kurobara
</span><span class='line'>│       │       ├── Main.java &lt;- これを追加
</span><span class='line'>│       │       └── MyResource.java
</span><span class='line'>│       ├── resources
</span><span class='line'>│       └── webapp
</span><span class='line'>│           ├── WEB-INF
</span><span class='line'>│           │   └── web.xml
</span><span class='line'>│           └── index.jsp</span></code></pre></td></tr></table></div></figure>


<h3>動作確認</h3>

<hr />

<p>まずは、テストが動くかどうか確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$gradle clean
</span><span class='line'>$gradle test</span></code></pre></td></tr></table></div></figure>


<p>次にアプリをビルドし、サーバを起動</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$gradle clean
</span><span class='line'>$gradle build
</span><span class='line'>$gradle jettyRunWar</span></code></pre></td></tr></table></div></figure>


<p>以下のコマンドで<code>Got it!</code>が返却されるか確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -v http://localhost:8090/kurobara/webapi/myresource</span></code></pre></td></tr></table></div></figure>


<h3>Heroku環境用の準備</h3>

<hr />

<p>Herokuで動かすJavaのバージョンを指定するsystem.propertiesを作成<br/>
(以下のようにとりあえず確実に動作するバージョンを指定)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java.runtime.version=1.7</span></code></pre></td></tr></table></div></figure>


<p>Procfileに記載するスクリプトファイルの確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$gradle stage</span></code></pre></td></tr></table></div></figure>


<p>こういう形にビルド結果が出力されているので、アプリケーション起動スクリプトのファイルパスを確認する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── build
</span><span class='line'>│   ├── classes
</span><span class='line'>│   │   └── main
</span><span class='line'>│   │       └── kurobara
</span><span class='line'>│   │           ├── Main.class
</span><span class='line'>│   │           └── MyResource.class
</span><span class='line'>│   ├── dependency-cache
</span><span class='line'>│   ├── install
</span><span class='line'>│   │   └── kurobara
</span><span class='line'>│   │       ├── bin
</span><span class='line'>│   │       │   ├── kurobara &lt;- これが起動用ファイル
</span><span class='line'>│   │       │   └── kurobara.bat</span></code></pre></td></tr></table></div></figure>


<p>生成したスクリプトファイルパスをProcfileに記載</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>web: ./build/install/kurobara/bin/kurobara</span></code></pre></td></tr></table></div></figure>


<p>不要ファイルを無視するように.gitignoreを作成<br/>
(Herokuへのデプロイはgitのため)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>build/
</span><span class='line'>.gradle/</span></code></pre></td></tr></table></div></figure>


<p>最終的に以下の構成になります</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── .gitignore
</span><span class='line'>├── Procfile
</span><span class='line'>├── build.gradle
</span><span class='line'>├── src
</span><span class='line'>│   └── main
</span><span class='line'>│       ├── java
</span><span class='line'>│       │   └── moonstruckdrops
</span><span class='line'>│       │       ├── Main.java
</span><span class='line'>│       │       └── MyResource.java
</span><span class='line'>│       ├── resources
</span><span class='line'>│       └── webapp
</span><span class='line'>│           ├── WEB-INF
</span><span class='line'>│           │   └── web.xml
</span><span class='line'>│           └── index.jsp
</span><span class='line'>└── system.properties</span></code></pre></td></tr></table></div></figure>


<h3>Herokuへdeploy</h3>

<hr />

<p>herokuへloginする</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew install heroku
</span><span class='line'>$ heroku login</span></code></pre></td></tr></table></div></figure>


<p>サーバへデプロイする</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git init
</span><span class='line'>$ git add .
</span><span class='line'>$ git commit -m "Ready to deploy"
</span><span class='line'>$ git remote add heroku your_heroku_path
</span><span class='line'>$ git push heroku master</span></code></pre></td></tr></table></div></figure>


<p>以下のコマンドで<code>Got it!</code>が返却されるか動作確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$curl -v http://your_app.herokuapp.com/webapi/myresource</span></code></pre></td></tr></table></div></figure>


<h3>感想</h3>

<hr />

<p>書くと簡単でしたが、実際にやってみると思った以上に嵌まりどころが多かった</p>

<p>特に以下が盛大な罠でした</p>

<ul>
<li>Procfileに書くファイルはどれなのか</li>
<li><code>heroku logs</code>を確認すると<code>app crash</code>と表示されて何がなんだかわからんかったこと</li>
<li><code>app crash</code>起因ですがweb.xmlはいじらなくてもいいのか？なんて思ったこと</li>
</ul>


<p>一度環境さえ準備できれば開発に専念できるようになるので、非常に楽ですね</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[なぜApacheとTomcatを連携させるのか]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/03/17/apache-plus-tomcat/"/>
    <updated>2015-03-17T00:12:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/03/17/apache-plus-tomcat</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>同僚とApacheとTomcatって何で連携させるんだっけ？<br/>
という話が出たので備忘録的に記載しておきます</p>

<p>ぶっちゃけ、今更感がすごい内容ですが・・・</p>

<h3>Apache</h3>

<hr />

<p>ざっくり言うと、クライアントのブラウザからアクセスし、サービスを提供するためのWebサーバソフトウェア</p>

<h3>Tomcat</h3>

<hr />

<p>こちらもざっくり言うと、以下のもの</p>

<ul>
<li>「サーブレット・コンテナ」(Servlet等を動作させるために必要なWebアプリケーションサーバ)</li>
<li>Servletのインスタンス管理やセッションの管理</li>
<li>Webサーバ機能有り(主に開発とデバッグ用)</li>
</ul>


<h3>連携理由</h3>

<hr />

<p>開発、デバッグ用途としてWebサーバ機能があるので、問題はないのですが
そもそもとして、ApacheなどのWebサーバの性能と同等に捌けるかは疑問があったりするところ</p>

<p>なので、以下の処理分担としたほうが効率よく捌けるため連携をさせることが多い</p>

<ul>
<li>静的コンテンツ(HTMLや画像ファイルなど)の処理はApacheが担当(何故なら、高速でTomcatに比べて高速に処理できるから)</li>
<li>動的コンテンツに関しての処理をTomcatが担当</li>
</ul>


<p>所謂、餅は餅屋ということですな</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[APIを作る際のAPIバージョンに関するメモ]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/02/18/api-life-cycle/"/>
    <updated>2015-02-18T23:19:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/02/18/api-life-cycle</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>APIを作るときにどうするか？を開発チーム内で議論したので、備忘録的なメモ</p>

<p>発端となった会話は、こんな感じだったはず</p>

<p>「マイクロアーキテクチャなサービスを作ったときってAPIを作ると思うけど、ライフサイクルって考えてる？」<br/>
「APIを利用するフロントは更新できるけど、APIは依存されるものが多いから簡単には更新できないよね？」<br/>
「APIってモバイルアプリからも利用した場合、修正しづらくない？バージョン管理でもするの？」</p>

<h3>APIの種別</h3>

<hr />

<p>以下の３つぐらいになりそう</p>

<ul>
<li>外部公開向け</li>
<li>モバイルアプリ向け</li>
<li>webサービス向け</li>
</ul>


<h3>外部公開向け</h3>

<hr />

<ul>
<li>API変更の影響が大きい</li>
<li>ドキュメント更新必須</li>
<li>利用者が離れるのでドラスティックな変更はできない</li>
<li>利用者への周知が必須</li>
</ul>


<h3>モバイルアプリ向け</h3>

<hr />

<ul>
<li>アプリのみが影響を受けるので、API変更における影響は少ない</li>
<li>アプリバージョンによるので自由にAPI更新ができない</li>
<li>OSバージョンによってアプリのアップデートができないことが多いので、更新によって使えなくなる可能性有</li>
<li>更新API対応のアプリであっても、アプリが更新されることは無いと思ったほうがよい</li>
</ul>


<h3>webサービス向け</h3>

<hr />

<ul>
<li>クライアントもAPIに合わせて最新にできるので、変更しやすい</li>
<li>キャッシュされたクライアントのコードとのデータ不整合が起きやすい</li>
<li>キャッシュに振り回される(iOSのwebview等)</li>
</ul>


<h3>バージョニング方式</h3>

<hr />

<p>APIのバージョン管理方式は以下のものが採用される傾向にある</p>

<ol>
<li>アクセス先URIそのものを大きく変更する</li>
<li>URIにバージョンを埋め込む</li>
<li>クエリに使用APIバージョンを入れる</li>
<li>メディアタイプにバージョンを指定する</li>
</ol>


<p>世間的には、2のパターンが比較的多く採用される傾向</p>

<h3>URIにバージョンを埋め込み方式</h3>

<hr />

<ul>
<li>「v1」のように「v」をつけてバージョンを明確にすることが多い</li>
<li>日付やリリースバージョン(ハッシュ等)をバージョンにするAPIもある(twillo等)</li>
<li>URIに組み込むバージョンは、メジャー番号のみを含める</li>
<li>APIの修正は、後方互換を保ちつつ対応する</li>
</ul>


<p>バージョニングは以下のセマンティックバージョニング方式を取ることが多い</p>

<ul>
<li>パッチバージョンは、ソフトウェアのAPIに変更がないバグ修正を行ったときに増える</li>
<li>マイナーバージョンは後方互換がある機能変更、特定の機能追加のときに増える</li>
<li>メジャーバージョンは後方互換が無い変更の時に増える</li>
</ul>


<h3>メディアタイプにバージョンを指定する</h3>

<hr />

<ul>
<li>「Accept: application/vnd.example.v2+json」のような形で規定する</li>
<li>URIがリソースを表しているので、HTTPの文法に則っている</li>
<li>「Content-Type」の指定誤りで、サーバ、クライアント側ともにエラーになりやすい傾向</li>
</ul>


<h3>バージョン変更指針</h3>

<hr />

<ul>
<li>APIは基本変更しないほうがよい</li>
<li>変更は後方互換を保ちつつ対応できる場合は、マイナーバージョンアップ(可能な限りこちらを選択)</li>
<li>後方互換が保てない修正の場合はメジャーバージョンアップ</li>
<li>レスポンスデータ整合性/整理のためであれば、バージョンは上げない(後方互換を維持し続け、ドキュメント整理で対応)</li>
</ul>


<h3>メジャーバージョンアップ指針</h3>

<hr />

<p>後方互換が保てない場合のみ実施し、バージョンアップのルールを整理してから行う</p>

<ul>
<li>セキュリティ/権限などのAPI使用ルール変更</li>
<li>認証方式の変更</li>
<li>乱雑に作った(ルールが無い)APIを使いやすくするための整備</li>
</ul>


<h3>APIの提供終了</h3>

<hr />

<ul>
<li>API提供終了前に提供終了日時のアナウンスをする(提供終了後、半年ほどは動かしておくこと)</li>
<li>提供終了までにAPIを利用できなくするブラックアウトテストを数回実施する</li>
<li>API提供終了の仕様をドキュメントに盛り込んでおく(HTTPのステータスコード410(Gone)を返すなど)</li>
<li>利用期限をAPI提供開始時に決めておく</li>
<li>古いAPIを叩いたときに、新APIへのリダイレクトは、混乱を招くので避けたほうがよい</li>
</ul>


<p># モバイル向けAPIの場合、ユーザー体験に直結するので仕様として予め考えておく(モバイル向けの場合、APIの停止はトレンドを見つつ行うこと)
# アプリのアップデートを促すようにしておく(強制アップデートは好まれないが、使えなくなるよりも遥かにマシ)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linuxのログイン履歴確認]]></title>
    <link href="http://moonstruckdrops.github.com/blog/2015/02/18/linux-login-check/"/>
    <updated>2015-02-18T01:20:00+09:00</updated>
    <id>http://moonstruckdrops.github.com/blog/2015/02/18/linux-login-check</id>
    <content type="html"><![CDATA[<h3>はじめに</h3>

<hr />

<p>毎度なんだっけ？ってなって思い出すのが面倒なので、備忘録的にログイン履歴確認方法を記録</p>

<h3>最近ログインしたアカウント一覧</h3>

<hr />

<p>以下のコマンドで確認できる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$last</span></code></pre></td></tr></table></div></figure>


<p>実行結果(上に行くほど最新)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root     tty1                          Tue May  6 18:59 - crash  (00:16)
</span><span class='line'>root     tty1                          Tue May  6 18:58 - 18:59  (00:00)
</span><span class='line'>reboot   system boot  2.6.32-431.11.2. Tue May  6 17:16 - 21:21  (04:04)</span></code></pre></td></tr></table></div></figure>


<h3>ログファイルから確認する</h3>

<hr />

<p>もう少し細かく見る場合はログファイルを確認する<br/>
バイナリなので中を見たいときはwhoコマンドを使用する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$who /var/log/wtmp</span></code></pre></td></tr></table></div></figure>


<p>実行結果(ログファイルなので、ファイル末尾が新しい)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root     tty1         2014-05-06 18:58
</span><span class='line'>root     tty1         2014-05-06 18:59
</span><span class='line'>root     tty1         2014-05-06 19:19</span></code></pre></td></tr></table></div></figure>


<h3>各アカウントの最終ログインの一覧</h3>

<hr />

<p>普段利用していないアカウントでログインされていないか確認できる<br/>
以下のコマンドで確認できる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$lastlog</span></code></pre></td></tr></table></div></figure>


<p>実行結果(各アカウントの最終ログインが表示)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ユーザ名         ポート   場所             最近のログイン
</span><span class='line'>root             tty1                      **一度もログインしていません**
</span><span class='line'>bin                                        **一度もログインしていません**
</span><span class='line'>daemon                                     **一度もログインしていません**
</span><span class='line'>adm                                        **一度もログインしていません**
</span><span class='line'>lp                                         **一度もログインしていません**
</span><span class='line'>sync                                       **一度もログインしていません**
</span><span class='line'>shutdown                                   **一度もログインしていません**</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
